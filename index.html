<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Bisnis - Profesional</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat html2pdf.js untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Menggunakan font Inter secara default */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; 
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Konten utama mengisi ruang yang tersedia */
        main {
            flex-grow: 1; 
        }

        /* Kelas untuk mencegah scrolling saat sidebar aktif */
        body.overflow-hidden {
            overflow: hidden;
        }
        
        /* Definisi font kustom */
        .font-times { font-family: 'Times New Roman', serif; }
        .font-calibri { font-family: 'Calibri', sans-serif; }

        /* --- CSS PRATINJAU KERTAS FLUID (DESKTOP) --- */
        #content-preview {
            padding: 2rem 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #letter-container {
            /* Container menampung kertas, menentukan lebar maksimum */
            max-width: 900px; 
            width: 100%;
            margin-bottom: 2rem;
            padding: 0 1rem; /* Tambahkan sedikit padding horizontal */
        }

        /* Aspect ratio wrapper untuk menahan rasio A4/F4 */
        #aspect-ratio-wrapper {
            position: relative;
            width: 100%;
            /* padding-bottom akan diatur oleh JS untuk menjaga rasio (misalnya 141.42% untuk A4) */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            background-color: white;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            overflow: hidden; 
        }

        #letter-content {
            /* Konten surat yang sebenarnya: posisikan absolut di dalam wrapper untuk aspek rasio */
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            padding: 25mm 20mm; /* Margin yang sesuai untuk cetak (2.5cm & 2cm) */
            font-size: 12pt; 
            transition: all 0.3s ease;
            margin: 0;
        }

        /* Kop Surat Style - Disesuaikan agar mirip format resmi */
        .kop-container {
            margin-bottom: 5px; 
        }
        .kop-header {
            /* GARIS TEBAL DI BAWAH KOP */
            border-bottom: 3px solid #000; 
            padding-bottom: 8px;
            margin-bottom: 0; /* Jarak dibuat dari margin-top Tanggal Surat */
        }
        .kop-teks {
            font-size: 12pt;
            line-height: 1.2;
            color: #1f2937; /* Gray-800 */
        }
        .kop-teks.utama {
            font-weight: bold;
        }
        .kop-teks.instansi {
            font-weight: bold;
            font-size: 14pt;
        }
        .kop-teks.alamat {
            font-size: 10pt;
            font-weight: normal;
        }

        /* --- PENGATURAN TEKS SURAT --- */
        .data-surat-row {
            display: flex;
            margin-bottom: 3px;
        }
        .data-surat-label {
            width: 80px; /* Lebar label (Nomor, Lampiran, Perihal) */
            flex-shrink: 0;
            font-weight: normal;
        }
        .data-surat-separator {
            width: 15px; /* Lebar untuk ':' */
            text-align: center;
            flex-shrink: 0;
        }
        
        /* Style umum untuk input form */
        .form-input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 1rem;
            background-color: #ffffff;
        }
        .form-input-field:focus {
            border-color: #10b981; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            outline: none;
        }

        /* Style mewah untuk tombol utama (PDF/Tab Terpilih) */
        .btn-primary {
            background-image: linear-gradient(to right, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px -5px rgba(16, 185, 129, 0.5);
        }
        .btn-primary:hover {
            box-shadow: 0 8px 20px -7px rgba(16, 185, 129, 0.7);
            transform: translateY(-2px);
            background-image: linear-gradient(to right, #059669 0%, #10b981 100%);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* Style untuk Tab Button */
        .tab-button {
            border-bottom: 3px solid transparent;
            color: #4b5563; 
        }

        .tab-button.active-preview {
            color: #059669; 
            border-bottom-color: #059669; 
            font-weight: 600;
        }

        .tab-button.active-edit {
            color: #ef4444; 
            border-bottom-color: #ef4444; 
            font-weight: 600;
        }

        /* Style khusus untuk overlay dan blur */
        #sidebar-overlay.active {
            opacity: 0.7;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(0, 0, 0, 0.7); 
        }

        /* Sidebar transition */
        #mobile-sidebar {
            transition: transform 0.3s ease-out; 
        }

        /* Notifikasi Toast (Pop-up) */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #10b981; /* bg-emerald-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: flex;
            align-items: center;
        }
        #toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Responsif: Nonaktifkan aspect ratio hack di mobile */
        @media (max-width: 1024px) {
            #letter-container {
                padding: 0; /* Hapus padding container di mobile */
            }
            #aspect-ratio-wrapper {
                box-shadow: none;
                border: none;
                border-radius: 0;
                padding-bottom: 0 !important; /* Hapus padding aspect ratio di mobile */
                position: static;
            }
            #letter-content {
                position: static; /* Kembali ke posisi statis */
                width: 95%; 
                height: auto; 
                min-height: auto !important;
                padding: 1.5rem 1rem; /* Padding yang lebih kecil */
                font-size: 11pt;
                margin: 0 auto;
            }
            .kop-teks { font-size: 11pt; }
            .kop-teks.instansi { font-size: 13pt; }
            /* Menyesuaikan margin untuk tanggal surat agar tidak terlalu jauh di mobile */
            #preview-tanggal-surat {
                margin-top: 5px; 
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Mobile Sidebar Overlay (70% Opacity Blur) -->
    <div id="sidebar-overlay" class="fixed inset-0 opacity-0 pointer-events-none transition-opacity duration-300 z-40" onclick="toggleSidebar(false)"></div>

    <!-- Mobile Sidebar Content -->
    <div id="mobile-sidebar" class="fixed right-0 top-0 h-full w-64 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out p-6 z-50">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Navigasi</h3>
            <button onclick="toggleSidebar(false)" class="text-gray-500 hover:text-gray-900 p-1 rounded-full">
                <!-- Close Icon (X) -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="flex flex-col space-y-4">
            <button id="mobile-tab-edit" onclick="showTab('edit')" class="tab-button w-full text-left active-edit px-4 py-2 rounded-lg hover:bg-red-50 text-red-500 border-b-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                Edit Data Surat
            </button>
            <button id="mobile-tab-preview" onclick="showTab('preview')" class="tab-button w-full text-left px-4 py-2 rounded-lg hover:bg-emerald-50 text-gray-500 border-b-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                Pratinjau & Unduh PDF
            </button>
        </div>
    </div>
    <!-- End Mobile Sidebar -->


    <!-- HEADER APLIKASI PROFESIONAL -->
    <header class="sticky top-0 z-20 bg-white border-b border-gray-200 shadow-lg">
        <div class="container mx-auto max-w-6xl flex justify-between items-center py-4 px-4 sm:px-8">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-emerald-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <h1 class="text-xl font-bold text-gray-800">SuratPro</h1>
            </div>

            <!-- DESKTOP TABS (Visible on sm and larger) -->
            <div id="desktop-tabs" class="hidden sm:flex space-x-2 border-b-2 border-gray-300">
                 <button id="desktop-tab-edit" onclick="showTab('edit')" class="tab-button active-edit px-4 py-3 text-sm font-medium transition-colors duration-200 focus:outline-none text-red-500 border-red-500 hover:bg-red-50" aria-current="page">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Edit Data Surat
                </button>
                <button id="desktop-tab-preview" onclick="showTab('preview')" class="tab-button px-4 py-3 text-sm font-medium text-gray-500 hover:text-emerald-700 transition-colors duration-200 focus:outline-none hover:bg-emerald-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Pratinjau & Unduh PDF
                </button>
            </div>

            <!-- MOBILE MENU (Visible on small screens) -->
            <div class="flex items-center space-x-4">
                <div id="auth-status" class="text-xs text-gray-500 hidden sm:block">
                    <!-- Status User ID akan ditampilkan di sini -->
                </div>
                <button id="hamburger-menu" class="sm:hidden text-gray-700 p-2 focus:outline-none rounded-lg hover:bg-gray-100 transition" onclick="toggleSidebar(true)">
                    <!-- Hamburger Icon -->
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-6xl p-4 sm:p-8">
        <div class="max-w-4xl mx-auto">
            
            <!-- Konten Aplikasi: Mode Edit (Form Input) -->
            <div id="content-edit" class="tab-content transition-opacity duration-300 bg-white p-6 sm:p-8 rounded-lg shadow-xl border border-gray-100">
                <div id="data-status" class="mb-4 p-3 rounded-lg text-center text-sm font-medium border bg-gray-50 border-gray-200">
                    <span id="save-status" class="text-gray-600">Status: Memuat data...</span>
                </div>

                <div class="space-y-8">
                     <!-- Pilihan Font -->
                    <div class="p-4 border-l-4 border-purple-500 bg-purple-50 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-xl text-gray-800 mb-4">0. Pengaturan Tampilan Dokumen</h3>
                        <div>
                            <label for="input-font-choice" class="block text-sm font-medium text-gray-700 mb-1">Pilih Jenis Font Dokumen</label>
                            <select id="input-font-choice" data-field="fontChoice" onchange="handleInputChange(this)" class="form-input-field">
                                <option value="font-times">Times New Roman (Serif, Formal)</option>
                                <option value="font-calibri">Calibri (Sans-serif, Modern)</option>
                            </select>
                        </div>
                    </div>


                    <!-- Bagian Kop Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-emerald-500 bg-gray-50 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-xl text-gray-800">1. Data Instansi & Logo</h3>
                        
                        <!-- NEW LOGO INPUTS -->
                        <div class="grid sm:grid-cols-2 gap-4 border-b pb-4 mb-4">
                            <div>
                                <label for="input-logo-kiri" class="block text-sm font-medium text-gray-700 mb-1">URL Logo Kiri</label>
                                <input type="url" id="input-logo-kiri" data-field="logoUrlKiri" oninput="handleInputChange(this)" class="form-input-field" placeholder="Masukkan URL gambar logo kiri...">
                            </div>
                            <div>
                                <label for="input-logo-kanan" class="block text-sm font-medium text-gray-700 mb-1">URL Logo Kanan</label>
                                <input type="url" id="input-logo-kanan" data-field="logoUrlKanan" oninput="handleInputChange(this)" class="form-input-field" placeholder="Masukkan URL gambar logo kanan...">
                            </div>
                        </div>

                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-kop-utama" class="block text-sm font-medium text-gray-700 mb-1">Kop Utama (Baris 1)</label>
                                <input type="text" id="input-kop-utama" data-field="kopUtama" oninput="handleInputChange(this)" class="form-input-field" value="PEMERINTAH KABUPATEN LEBAK">
                            </div>
                            <div>
                                <label for="input-kop-sub2" class="block text-sm font-medium text-gray-700 mb-1">Nama Instansi</label>
                                <input type="text" id="input-kop-sub2" data-field="namaInstansi" oninput="handleInputChange(this)" class="form-input-field" value="SMP NEGERI 2 CILELES">
                            </div>
                        </div>
                        <div>
                            <label for="input-tanggal-surat" class="block text-sm font-medium text-gray-700 mb-1">Tempat, Tanggal Surat</label>
                            <input type="text" id="input-tanggal-surat" data-field="tanggalSurat" oninput="handleInputChange(this)" class="form-input-field" value="Cileles, 25 Nopember 2025">
                        </div>
                         <div>
                            <label for="input-kop-alamat" class="block text-sm font-medium text-gray-700 mb-1">Alamat Instansi</label>
                            <input type="text" id="input-kop-alamat" data-field="kopAlamat" oninput="handleInputChange(this)" class="form-input-field" value="Alamat: Kp. Pasir Galatik Desa Gumuruh Kec. Cileles-Lebak">
                        </div>
                    </div>

                    <!-- Bagian Detail Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-amber-500 bg-white rounded-lg shadow">
                        <h3 class="font-semibold text-xl text-gray-800">2. Detail Surat</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-nomor" class="block text-sm font-medium text-gray-700 mb-1">Nomor</label>
                                <input type="text" id="input-nomor" data-field="nomor" oninput="handleInputChange(this)" class="form-input-field" value="421. /SMP/Filal/CLLS/XI/2025">
                            </div>
                            <div>
                                <label for="input-lampiran" class="block text-sm font-medium text-gray-700 mb-1">Lampiran</label>
                                <input type="text" id="input-lampiran" data-field="lampiran" oninput="handleInputChange(this)" class="form-input-field" value="-">
                            </div>
                        </div>
                        <div>
                            <label for="input-perihal" class="block text-sm font-medium text-gray-700 mb-1">Perihal</label>
                            <input type="text" id="input-perihal" data-field="perihal" oninput="handleInputChange(this)" class="form-input-field" value="Pemberitahuan Kegiatan PERJUSAMI">
                        </div>
                         <div>
                            <label for="input-tujuan-nama" class="block text-sm font-medium text-gray-700 mb-1">Tujuan (Kepada Yth.)</label>
                            <input type="text" id="input-tujuan-nama" data-field="tujuanNama" oninput="handleInputChange(this)" class="form-input-field" value="Bapak Kepala SMP Negeri 2 Cileles">
                        </div>
                    </div>

                    <!-- Bagian Isi Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-emerald-500 bg-gray-50 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-xl text-gray-800">3. Isi & Rincian Kegiatan</h3>
                        <div>
                            <label for="input-isi-utama-1" class="block text-sm font-medium text-gray-700 mb-1">Paragraf Pembuka/Utama</label>
                            <textarea id="input-isi-utama-1" data-field="isiUtama" oninput="handleInputChange(this)" rows="4" class="form-input-field">Dalam rangka meningkatkan kedisiplinan, kemandirian, serta kemampuan kepramukaan peserta didik sebagai generasi muda yang berkarakter dan berjiwa Pancasila, kami bermaksud akan melaksanakan kegiatan Perkembangan Jumat Sabtu Minggu (Perjusami). Sehubungan dengan hal tersebut, bersama ini kami memberitahukan bahwa kegiatan akan dilaksanakan pada:</textarea>
                        </div>
                        <div>
                            <label for="input-detail-kegiatan" class="block text-sm font-medium text-gray-700 mb-1">Rincian Kegiatan (Gunakan baris baru untuk setiap detail)</label>
                            <textarea id="input-detail-kegiatan" data-field="detailKegiatan" oninput="handleInputChange(this)" rows="4" class="form-input-field">Hari/Tanggal: Jumat s.d. minggu (7-9 Nopember 2025)
Pukul: 08.00 s.d Selesai
Tempat: Lapangan</textarea>
                        </div>
                        <div>
                            <label for="input-isi-penutup" class="block text-sm font-medium text-gray-700 mb-1">Paragraf Penutup</label>
                            <textarea id="input-isi-penutup" data-field="isiPenutup" oninput="handleInputChange(this)" rows="3" class="form-input-field">Demikian pemberitahuan ini kami sampaikan. Besar harapan kami Bapak Kepala Sekolah memberikan izin pelaksanaan kegiatan tersebut. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.</textarea>
                        </div>
                    </div>

                     <!-- Bagian Tanda Tangan -->
                    <div class="space-y-4 p-4 border-l-4 border-amber-500 bg-white rounded-lg shadow">
                        <h3 class="font-semibold text-xl text-gray-800">4. Penandatangan</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-jabatan-kiri" class="block text-sm font-medium text-gray-700 mb-1">Jabatan Kiri</label>
                                <input type="text" id="input-jabatan-kiri" data-field="jabatanKiri" oninput="handleInputChange(this)" class="form-input-field" value="Ketua Pelaksana Kegiatan">
                            </div>
                            <div>
                                <label for="input-jabatan-kanan" class="block text-sm font-medium text-gray-700 mb-1">Jabatan Kanan</label>
                                <input type="text" id="input-jabatan-kanan" data-field="jabatanKanan" oninput="handleInputChange(this)" class="form-input-field" value="Sekretaris">
                            </div>
                        </div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-nama-kiri" class="block text-sm font-medium text-gray-700 my-1">Nama Kiri</label>
                                <input type="text" id="input-nama-kiri" data-field="namaKiri" oninput="handleInputChange(this)" class="form-input-field" value="M. Nur Ikhwan, S. Pd.">
                            </div>
                            <div>
                                <label for="input-nama-kanan" class="block text-sm font-medium text-gray-700 my-1">Nama Kanan</label>
                                <input type="text" id="input-nama-kanan" data-field="namaKanan" oninput="handleInputChange(this)" class="form-input-field" value="Danu Septiana, S. Pd.">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Akhir Konten Aplikasi: Mode Edit -->

            <!-- Konten Aplikasi: Pratinjau & Unduh PDF -->
            <div id="content-preview" class="tab-content hidden transition-opacity duration-300">

                 <!-- Kontrol Unduh PDF -->
                <div class="max-w-4xl w-full p-6 bg-white rounded-lg shadow-xl mb-8 border border-gray-100 flex flex-col sm:flex-row justify-between items-center relative">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">Unduh Dokumen sebagai PDF</h2>
                    
                    <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                         <div class="w-full sm:w-auto">
                            <select id="paper-size-select" onchange="updatePreviewPaperSize(this.value)" class="form-input-field p-2 text-sm">
                                <option value="a4">Ukuran Kertas: A4 (Standar)</option>
                                <option value="f4">Ukuran Kertas: F4 / Folio (Panjang)</option>
                            </select>
                        </div>
                        <button onclick="prepareAndDownloadPdf()" class="btn-primary text-white px-6 py-2.5 rounded-lg text-sm font-semibold w-full sm:w-auto shadow-lg hover:shadow-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            Unduh PDF Sekarang
                        </button>
                    </div>

                    <div id="loading-message" class="hidden absolute top-0 left-0 w-full h-full bg-white bg-opacity-90 flex items-center justify-center rounded-lg">
                        <svg class="animate-spin h-8 w-8 text-emerald-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-emerald-700 font-semibold">Memproses PDF...</span>
                    </div>
                </div>

                <div id="letter-container">
                    <!-- NEW WRAPPER untuk menahan Aspect Ratio di Desktop -->
                    <div id="aspect-ratio-wrapper"> 
                        <div id="letter-content" class="font-times overflow-hidden">
                            
                            <!-- Kop Surat (Header) - Disesuaikan agar mirip format resmi -->
                            <div class="kop-container">
                                <div id="header-section" class="kop-header">
                                    <div class="flex items-center justify-between text-center">
                                        <!-- Logo Kiri -->
                                        <div class="w-1/10 flex justify-start">
                                            <img id="logo-kiri" src="" class="w-16 h-20 object-contain" alt="Logo Kiri" onerror="this.onerror=null; this.src='https://placehold.co/60x80/ffffff/000000?text=LOGO+KIRI';">
                                        </div>

                                        <!-- Teks Kop (80% Lebar) -->
                                        <div class="w-8/10 flex-grow text-center flex flex-col justify-center items-center">
                                            <p class="kop-teks utama" id="preview-kop-utama"></p>
                                            <p class="kop-teks" id="preview-kop-sub1"></p>
                                            <p class="kop-teks instansi" id="preview-kop-sub2"></p>
                                            <p class="kop-teks alamat" id="preview-kop-alamat"></p>
                                        </div>

                                         <!-- Logo Kanan -->
                                         <div class="w-1/10 flex justify-end">
                                            <img id="logo-kanan" src="" class="w-16 h-20 object-contain" alt="Logo Kanan" onerror="this.onerror=null; this.src='https://placehold.co/60x80/ffffff/000000?text=LOGO+KANAN';">
                                        </div>
                                    </div>
                                </div>

                                <!-- Tempat dan Tanggal (DI BAWAH GARIS) -->
                                <!-- Margin-top 5px agar lebih rapat ke garis -->
                                <p class="text-right text-base text-gray-800 pt-1" id="preview-tanggal-surat"></p>
                            </div>
                            <!-- Akhir Kop Surat -->

                            <!-- Informasi Surat (Nomor, Lampiran, Perihal) - Jarak 1.5 spasi -->
                            <div class="text-base mt-6 mb-8 leading-relaxed">
                                <div class="data-surat-row">
                                    <span class="data-surat-label">Nomor</span>
                                    <span class="data-surat-separator">:</span>
                                    <span id="preview-nomor"></span>
                                </div>
                                <div class="data-surat-row">
                                    <span class="data-surat-label">Lampiran</span>
                                    <span class="data-surat-separator">:</span>
                                    <span id="preview-lampiran"></span>
                                </div>
                                <div class="data-surat-row">
                                    <span class="data-surat-label">Perihal</span>
                                    <span class="data-surat-separator">:</span>
                                    <span id="preview-perihal"></span>
                                </div>
                            </div>

                            <!-- Alamat Tujuan -->
                            <div class="mb-6">
                                <p class="text-base mb-2">Kepada</p>
                                <p class="text-base font-semibold" id="preview-tujuan-nama"></p>
                                <p class="text-base">di Tempat</p>
                            </div>
                            
                            <!-- Salam Pembuka -->
                            <p class="text-base text-gray-800 mb-4">Dengan hormat,</p>

                            <!-- Isi Surat -->
                            <div class="text-gray-800 space-y-4 text-base leading-normal">
                                <p class="text-justify indent-10" id="preview-isi-utama-1"></p>

                                <!-- Detail Kegiatan (Diparsing dari textarea dengan baris baru) -->
                                <div class="ml-10 text-base space-y-1" id="preview-detail-kegiatan">
                                    <!-- Konten akan diisi oleh JS -->
                                </div>
                                
                                <p class="text-justify indent-10 mt-6" id="preview-isi-penutup"></p>
                            </div>

                            <!-- Penutup dan Tanda Tangan (Format Dua Kolom) -->
                            <div class="mt-20 text-base flex">
                                <!-- Kolom Kiri -->
                                <div class="w-1/2 flex flex-col items-start pr-12">
                                    <p class="font-normal mb-1">Hormat kami,</p> 
                                    
                                    <!-- Jabatan Kiri -->
                                    <p class="font-medium text-base mb-16" id="preview-jabatan-kiri"></p>
                                    
                                    <!-- Nama Kiri -->
                                    <p class="font-bold border-b-2 border-gray-700 inline-block px-1" id="preview-nama-kiri"></p>
                                    <p class="text-xs text-transparent">.</p> <!-- Menjaga jarak baris -->
                                </div>

                                <!-- Kolom Kanan -->
                                <div class="w-1/2 flex flex-col items-start pl-12">
                                    <p class="font-normal mb-1">&nbsp;</p> 

                                    <!-- Jabatan Kanan -->
                                    <p class="font-medium text-base mb-16" id="preview-jabatan-kanan"></p>
                                    
                                    <!-- Nama Kanan -->
                                    <p class="font-bold border-b-2 border-gray-700 inline-block px-1" id="preview-nama-kanan"></p>
                                    <p class="text-xs text-transparent">.</p> <!-- Menjaga jarak baris -->
                                </div>
                            </div>
                            <!-- Catatan: Untuk penandatangan mengetahui/menyetujui, biasanya ditambahkan di kiri atas, namun saya hanya mengikuti layout dua kolom di gambar Anda. -->

                        </div>
                    </div> <!-- END ASPECT RATIO WRAPPER -->
                </div>
            </div>
            <!-- Akhir Konten Aplikasi: Pratinjau & Unduh PDF -->

        </div>
    </main>

    <!-- Notifikasi Toast (Pop-up) -->
    <div id="toast-notification" class="transition-all duration-300">
        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        <span id="toast-message">Surat berhasil diunduh sebagai PDF!</span>
    </div>

    <!-- Footer Simple - Jarak Diperpendek menjadi mt-8 -->
    <footer class="bg-gray-800 text-white mt-8 p-4 text-center">
        <div class="container mx-auto max-w-4xl text-sm opacity-80">
            <p>Sistem Generator Dokumen (Versi Lokal) | Data Disimpan di LocalStorage</p>
        </div>
    </footer>

    <script type="module">
        // --- DATA LOKAL (PENGGANTI FIREBASE) ---
        
        // Data default untuk surat
        const DEFAULT_DATA = {
            fontChoice: "font-times", 
            logoUrlKiri: "https://placehold.co/60x80/ffffff/000000?text=LOGO+KIRI", 
            logoUrlKanan: "https://placehold.co/60x80/ffffff/000000?text=LOGO+KANAN",
            kopUtama: "PEMERINTAH KABUPATEN LEBAK",
            kopSub1: "DINAS PENDIDIKAN DAN KEBUDAYAAN",
            namaInstansi: "SMP NEGERI 2 CILELES",
            kopAlamat: "Alamat: Kp. Pasir Galatik Desa Gumuruh Kec. Cileles-Lebak",
            tanggalSurat: "Cileles, 25 Nopember 2025",
            nomor: "421. /SMP/Filal/CLLS/XI/2025",
            lampiran: "-",
            perihal: "Pemberitahuan Kegiatan PERJUSAMI",
            tujuanNama: "Bapak Kepala SMP Negeri 2 Cileles",
            isiUtama: "Dalam rangka meningkatkan kedisiplinan, kemandirian, serta kemampuan kepramukaan peserta didik sebagai generasi muda yang berkarakter dan berjiwa Pancasila, kami bermaksud akan melaksanakan kegiatan Perkembangan Jumat Sabtu Minggu (Perjusami). Sehubungan dengan hal tersebut, bersama ini kami memberitahukan bahwa kegiatan akan dilaksanakan pada:",
            detailKegiatan: "Hari/Tanggal: Jumat s.d. minggu (7-9 Nopember 2025)\nPukul: 08.00 s.d Selesai\nTempat: Lapangan",
            isiPenutup: "Demikian pemberitahuan ini kami sampaikan. Besar harapan kami Bapak Kepala Sekolah memberikan izin pelaksanaan kegiatan tersebut. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.",
            jabatanKiri: "Ketua Pelaksana Kegiatan",
            namaKiri: "M. Nur Ikhwan, S. Pd.",
            jabatanKanan: "Sekretaris",
            namaKanan: "Danu Septiana, S. Pd.",
        };

        let letterData = { ...DEFAULT_DATA };
        let saveTimeout = null;
        let currentTab = 'edit'; 

        // Fungsi untuk menyimpan data ke LocalStorage dengan debounce
        function saveDataToLocalStorage(data) {
            if (saveTimeout) clearTimeout(saveTimeout);
            
            document.getElementById('save-status').textContent = 'Status: Menyimpan... (Lokal)';

            saveTimeout = setTimeout(() => {
                try {
                    // Simpan data ke localStorage
                    localStorage.setItem('suratPro_data', JSON.stringify(data)); 
                    document.getElementById('save-status').textContent = 'Status: Tersimpan di penyimpanan lokal (LocalStorage).';
                    // Reset styling status
                    document.getElementById('data-status').classList.remove('bg-red-100', 'border-red-400', 'bg-yellow-100', 'border-yellow-400');
                    document.getElementById('save-status').classList.remove('text-red-700', 'text-yellow-700');
                    document.getElementById('data-status').classList.add('bg-gray-50', 'border-gray-200');
                    document.getElementById('save-status').classList.add('text-gray-600');
                } catch (error) {
                    console.error("Error saving data to LocalStorage:", error);
                    document.getElementById('save-status').textContent = 'Error: Gagal menyimpan data lokal! (LocalStorage penuh?)';
                    document.getElementById('data-status').classList.add('bg-red-100', 'border-red-400');
                    document.getElementById('save-status').classList.add('text-red-700');
                }
            }, 500); 
        }
        window.saveDataToLocalStorage = saveDataToLocalStorage; 

        // Fungsi untuk memuat data dari LocalStorage
        function loadDataFromLocalStorage() {
            document.getElementById('save-status').textContent = 'Status: Memuat data dari penyimpanan lokal...';
            try {
                const storedData = localStorage.getItem('suratPro_data');
                if (storedData) {
                    letterData = { ...DEFAULT_DATA, ...JSON.parse(storedData) }; 
                    document.getElementById('save-status').textContent = 'Status: Data dimuat dari LocalStorage.';
                } else {
                    document.getElementById('save-status').textContent = 'Status: Data baru. Menggunakan default.';
                    saveDataToLocalStorage(letterData); 
                }
                document.getElementById('auth-status').textContent = `Penyimpanan: Lokal (Browser)`; 
                
            } catch (error) {
                console.error("Error loading data from LocalStorage:", error);
                document.getElementById('save-status').textContent = 'Error: Gagal memuat data dari LocalStorage.';
                document.getElementById('data-status').classList.add('bg-red-100', 'border-red-400');
                document.getElementById('save-status').classList.add('text-red-700');
            }

            syncDataToForms();
            synchronizePreview();
        }

        // --- INISIALISASI APLIKASI ---
        function initApp() {
            loadDataFromLocalStorage();
        }

        // --- HANDLERS DOM ---
        
        function handleInputChange(element) {
            const field = element.getAttribute('data-field');
            const value = element.value;
            
            if (field) {
                letterData[field] = value;
                saveDataToLocalStorage(letterData); // Ganti RTDB dengan LocalStorage
                synchronizePreview(); 
            }
        }
        window.handleInputChange = handleInputChange; 

        function syncDataToForms() {
            document.querySelectorAll('[data-field]').forEach(el => {
                const field = el.getAttribute('data-field');
                if (letterData[field] !== undefined && el.value !== letterData[field]) {
                    el.value = letterData[field];
                }
            });
        }
        
        // Fungsi untuk menyesuaikan tinggi pratinjau sesuai ukuran kertas (mempertahankan aspek rasio)
        function updatePreviewPaperSize(size) {
            const aspectRatioWrapper = document.getElementById('aspect-ratio-wrapper');
            const isMobile = window.innerWidth < 1024;
            
            // Di mobile, kita tidak perlu aspect ratio hack karena layoutnya responsif penuh
            if (isMobile) {
                aspectRatioWrapper.style.paddingBottom = '0';
                return;
            }

            let paddingPercentage;
            if (size === 'f4') {
                // F4/Folio (215mm x 330mm) Ratio: 330/215 ≈ 153.49%
                paddingPercentage = '153.49%';
            } else {
                // A4 (210mm x 297mm) Ratio: 297/210 ≈ 141.42%
                paddingPercentage = '141.42%';
            }
            
            // Set padding-bottom untuk menahan aspect ratio
            aspectRatioWrapper.style.paddingBottom = paddingPercentage;
        }
        window.updatePreviewPaperSize = updatePreviewPaperSize;

        function synchronizePreview() {
            const contentElement = document.getElementById('letter-content');

            // 1. Terapkan Pilihan Font
            contentElement.classList.remove('font-times', 'font-calibri');
            contentElement.classList.add(letterData.fontChoice);
            updatePreviewPaperSize(document.getElementById('paper-size-select').value);

            // 2. Sinkronkan Logo
            document.getElementById('logo-kiri').src = letterData.logoUrlKiri;
            document.getElementById('logo-kanan').src = letterData.logoUrlKanan;

            // 3. Sinkronkan konten teks
            document.getElementById('preview-kop-utama').textContent = letterData.kopUtama;
            document.getElementById('preview-kop-sub1').textContent = letterData.kopSub1;
            document.getElementById('preview-kop-sub2').textContent = letterData.namaInstansi;
            document.getElementById('preview-kop-alamat').textContent = letterData.kopAlamat;
            document.getElementById('preview-tanggal-surat').textContent = letterData.tanggalSurat;
            
            // Detail Surat
            document.getElementById('preview-nomor').textContent = letterData.nomor;
            document.getElementById('preview-lampiran').textContent = letterData.lampiran;
            document.getElementById('preview-perihal').textContent = letterData.perihal;
            
            // Tujuan
            let tujuanNama = letterData.tujuanNama;
            document.getElementById('preview-tujuan-nama').textContent = tujuanNama;

            document.getElementById('preview-isi-utama-1').textContent = letterData.isiUtama;
            document.getElementById('preview-isi-penutup').textContent = letterData.isiPenutup;

            // Detail Kegiatan (parsing baris baru)
            const detailKegiatanContainer = document.getElementById('preview-detail-kegiatan');
            const detailText = letterData.detailKegiatan || '';
            detailKegiatanContainer.innerHTML = ''; 
            
            detailText.split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parts.slice(1).join(':').trim(); 
                    
                    const div = document.createElement('div');
                    div.className = 'flex data-surat-row'; 
                    div.innerHTML = `
                        <span class="data-surat-label">${key}</span>
                        <span class="data-surat-separator">:</span>
                        <span class="flex-grow">${value}</span>
                    `;
                    detailKegiatanContainer.appendChild(div);
                }
            });
            
            // Tanda Tangan
            document.getElementById('preview-jabatan-kiri').textContent = letterData.jabatanKiri;
            document.getElementById('preview-nama-kiri').textContent = letterData.namaKiri;
            document.getElementById('preview-jabatan-kanan').textContent = letterData.jabatanKanan;
            document.getElementById('preview-nama-kanan').textContent = letterData.namaKanan;
        }

        // --- Fungsi Notifikasi Toast ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // Mengubah warna dan ikon jika terjadi error
            if (isError) {
                toast.classList.remove('bg-emerald-500');
                toast.classList.add('bg-red-600');
                // Mengganti ikon menjadi peringatan (X atau alert)
                toast.querySelector('svg').outerHTML = `
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                `;
            } else {
                toast.classList.add('bg-emerald-500');
                toast.classList.remove('bg-red-600');
                // Mengganti ikon kembali menjadi centang
                toast.querySelector('svg').outerHTML = `
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                `;
            }

            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // Notifikasi akan hilang setelah 3 detik
        }
        window.showToast = showToast;


        // --- Fungsi Pengaturan Tampilan (Tabs & Sidebar) ---
        
        function toggleSidebar(open) {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (open) {
                sidebar.classList.remove('translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.add('active'); 
                document.body.classList.add('overflow-hidden');
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('translate-x-full');
                overlay.classList.remove('active');
                document.body.classList.remove('overflow-hidden');
            }
        }
        window.toggleSidebar = toggleSidebar;

        function showTab(tabName) {
            currentTab = tabName;
            
            if (window.innerWidth < 640) {
                toggleSidebar(false);
            }

            // Atur tampilan Konten
            const contents = [document.getElementById('content-edit'), document.getElementById('content-preview')];
            contents.forEach(c => c.classList.add('hidden', 'opacity-0'));
            
            const selectedContent = document.getElementById(`content-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                setTimeout(() => selectedContent.classList.remove('opacity-0'), 10);
            }

            // Atur tampilan Tombol (Desktop & Mobile)
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active-preview', 'active-edit');
                btn.classList.add('text-gray-500');
            });
            
            const tabElements = [`#desktop-tab-${tabName}`, `#mobile-tab-${tabName}`];
            
            tabElements.forEach(selector => {
                const selectedTab = document.querySelector(selector);
                if (selectedTab) {
                    if (tabName === 'preview') {
                        selectedTab.classList.add('active-preview');
                        selectedTab.classList.remove('text-gray-500');
                    } else {
                        selectedTab.classList.add('active-edit');
                        selectedTab.classList.remove('text-gray-500');
                    }
                }
            });

            const otherTabName = tabName === 'edit' ? 'preview' : 'edit';
            const otherTabElements = [`#desktop-tab-${otherTabName}`, `#mobile-tab-${otherTabName}`];

            otherTabElements.forEach(selector => {
                const otherTab = document.querySelector(selector);
                if (otherTab) {
                    otherTab.classList.remove('active-edit', 'active-preview');
                    otherTab.classList.add('text-gray-500');
                }
            });

            if (tabName === 'preview') synchronizePreview();
        }
        window.showTab = showTab; 

        // --- Fungsi Unduh PDF ---
        function prepareAndDownloadPdf() {
            const paperSize = document.getElementById('paper-size-select').value;
            const content = document.getElementById('letter-content');
            const loadingMessage = document.getElementById('loading-message');

            loadingMessage.classList.remove('hidden');
            
            let paperOptions;
            let filename;

            if (paperSize === 'a4') {
                // A4: 210mm x 297mm
                paperOptions = { width: 210, height: 297 };
                filename = 'Surat-A4-Profesional.pdf';
            } else if (paperSize === 'f4') {
                // F4/Folio: 215mm x 330mm (Ukuran umum di Indonesia)
                paperOptions = { width: 215, height: 330 }; 
                filename = 'Surat-F4-Profesional.pdf';
            } else {
                console.error("Ukuran kertas tidak valid.");
                showToast("Error: Ukuran kertas tidak valid.", true);
                loadingMessage.classList.add('hidden');
                return;
            }

            // Opsi html2pdf
            const opt = {
                // Mengatur margin default (misalnya 15mm)
                margin: [15, 15, 15, 15], 
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    logging: false,
                },
                jsPDF: { unit: 'mm', format: paperOptions, orientation: 'portrait' }
            };

            // Ambil elemen yang akan dicetak (letter-content)
            const elementToPrint = document.getElementById('letter-content');
            
            // Gunakan promise chain dengan .finally() untuk memastikan loading indicator disembunyikan
            html2pdf().set(opt).from(elementToPrint).save()
                .then(() => {
                    // Tampilkan notifikasi berhasil unduh
                    showToast(`Berhasil mengunduh dokumen: ${filename}`, false);
                })
                .catch(error => {
                    console.error("PDF generation failed:", error);
                    showToast("Gagal mengunduh PDF. Cek konsol untuk detail.", true);
                })
                .finally(() => {
                    // Pastikan loading message disembunyikan, baik berhasil atau gagal
                    loadingMessage.classList.add('hidden');
                });
        }
        window.prepareAndDownloadPdf = prepareAndDownloadPdf; 

        // --- START APLIKASI ---
        initApp(); // Ganti dari initFirebase ke initApp

        document.addEventListener('DOMContentLoaded', () => {
             showTab('edit');
             // Panggil updatePreviewPaperSize untuk pertama kali dengan default A4
             updatePreviewPaperSize('a4'); 
        });
        
        // Listener untuk menyesuaikan aspect ratio ketika jendela diubah ukurannya (Desktop <-> Mobile)
        window.addEventListener('resize', () => {
             updatePreviewPaperSize(document.getElementById('paper-size-select').value);
        });

    </script>

</body>
</html>