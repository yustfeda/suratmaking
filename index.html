<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Ujian Sekolah Realtime (Realtime Database)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Warna latar belakang abu-abu muda */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="bg-white p-6 rounded-xl mb-8 card">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Sistem Ujian Sekolah Online</h1>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <span id="user-display" class="text-sm font-medium text-gray-600 bg-gray-100 p-2 rounded-lg">Memuat...</span>
                    <button id="logout-btn" onclick="app.logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Ganti Peran</button>
                </div>
            </div>
            <p id="user-id-display" class="text-xs text-gray-500 mt-2">UID: -</p>
        </header>

        <!-- Loading State -->
        <div id="loading" class="text-center p-12 bg-white rounded-xl card">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuat konfigurasi dan otentikasi...</p>
        </div>

        <!-- Role Selector (Hanya untuk demonstrasi sederhana) -->
        <div id="role-selector" class="hidden max-w-md mx-auto p-8 bg-white rounded-xl card text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Pilih Peran Anda</h2>
            <div class="space-y-4">
                <button onclick="app.setRole('admin1')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 transform hover:scale-[1.02]">Admin Utama (Kelola Jadwal & Rekap Nilai)</button>
                <button onclick="app.setRole('admin2')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 transform hover:scale-[1.02]">Guru/Proktor (Kelola Soal & Rekap Mapel)</button>
                <button onclick="app.setRole('student')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 transform hover:scale-[1.02]">Siswa (Ambil Ujian)</button>
            </div>
            <p class="text-sm text-gray-500 mt-6">Peran diatur secara lokal untuk demonstrasi. Di aplikasi nyata, ini diatur melalui proses masuk.</p>
        </div>

        <!-- Halaman Admin Utama (Admin 1) -->
        <div id="admin1-panel" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Panel Admin Utama</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Kelola Jadwal Ujian -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl card h-fit">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Kelola Jadwal Ujian</h3>
                    <form id="schedule-form" class="space-y-4">
                        <input type="text" id="subject-id" placeholder="ID Mapel (misal: MTK)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="text" id="subject-name" placeholder="Nama Mata Pelajaran" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="date" id="subject-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="time" id="subject-time-start" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <input type="time" id="subject-time-end" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <select id="subject-proctor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Pilih Proktor/Admin 2 (Opsional)</option>
                        </select>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150">Simpan Jadwal</button>
                    </form>
                </div>

                <!-- Daftar Jadwal & Proktor -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl card">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Jadwal Ujian Aktif</h3>
                    <div id="subjects-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500">Memuat jadwal...</p>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-4 text-blue-700 border-b pb-2">Daftar Admin 2 / Proktor</h3>
                    <div id="proctor-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500">Memuat proktor...</p>
                    </div>

                    <button onclick="app.openProctorModal()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-150">Tambah Admin 2 / Proktor Baru</button>
                </div>
            </div>

            <!-- Rekap Nilai Keseluruhan -->
            <div class="mt-8 bg-white p-6 rounded-xl card">
                <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Rekap Nilai Siswa Keseluruhan</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa (UID)</th>
                                <th id="recap-header-subjects" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Mata Pelajaran</th>
                            </tr>
                        </thead>
                        <tbody id="recap-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="2" class="px-3 py-4 text-sm text-gray-500">Memuat rekap data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Halaman Guru/Proktor (Admin 2) -->
        <div id="admin2-panel" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Panel Guru / Proktor</h2>
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-lg" role="alert">
                <p class="font-bold">Mapel Anda:</p>
                <p id="proctor-subject-info">Silakan pilih mapel yang Anda kelola di Panel Admin Utama.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Input Soal Ujian -->
                <div class="bg-white p-6 rounded-xl card h-fit">
                    <h3 class="text-xl font-semibold mb-4 text-blue-700 border-b pb-2">Input Soal Ujian (<span id="q-count">0</span>/55)</h3>
                    <form id="question-form" class="space-y-4">
                        <input type="number" id="q-number" placeholder="Nomor Soal (1-55)" min="1" max="55" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        <textarea id="q-text" placeholder="Teks Soal" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></textarea>
                        <!-- Pilihan Jawaban (A-E) -->
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="opt-a" placeholder="Pilihan A" class="p-3 border rounded-lg" required>
                            <input type="text" id="opt-b" placeholder="Pilihan B" class="p-3 border rounded-lg" required>
                            <input type="text" id="opt-c" placeholder="Pilihan C" class="p-3 border rounded-lg" required>
                            <input type="text" id="opt-d" placeholder="Pilihan D" class="p-3 border rounded-lg" required>
                        </div>
                        <input type="text" id="opt-e" placeholder="Pilihan E (Opsional)" class="p-3 border rounded-lg">
                        
                        <select id="q-key" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Pilih Kunci Jawaban (A/B/C/D/E)</option>
                            <option value="a">A</option><option value="b">B</option>
                            <option value="c">C</option><option value="d">D</option>
                            <option value="e">E</option>
                        </select>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-150">Simpan Soal</button>
                    </form>
                    <button onclick="app.clearQuestions()" class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-150">Hapus Semua Soal Mapel Ini</button>
                </div>
                
                <!-- Daftar Soal -->
                <div class="bg-white p-6 rounded-xl card">
                    <h3 class="text-xl font-semibold mb-4 text-blue-700 border-b pb-2">Daftar Soal (<span id="q-list-count">0</span>)</h3>
                    <div id="questions-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500">Daftar soal akan muncul di sini.</p>
                    </div>
                </div>
            </div>

            <!-- Rekap Nilai Siswa per Mapel -->
            <div class="mt-8 bg-white p-6 rounded-xl card">
                <h3 class="text-xl font-semibold mb-4 text-blue-700 border-b pb-2">Rekap Nilai Siswa Mapel: <span id="recap-mapel-title"></span></h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa (UID)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Submit</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Benar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai (Skor/Total)</th>
                            </tr>
                        </thead>
                        <tbody id="admin2-recap-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-4 text-sm text-gray-500">Menunggu data hasil ujian...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Halaman Siswa (Student) -->
        <div id="student-panel" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Profil & Pengumuman -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl card">
                        <h3 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">Profil Siswa</h3>
                        <p><strong>UID:</strong> <span id="student-profile-uid" class="text-xs text-gray-500"></span></p>
                        <p class="mt-2"><strong>Nama:</strong> <input type="text" id="student-name-input" placeholder="Isi Nama Anda" class="w-full p-2 border rounded-lg mt-1 focus:ring-emerald-500 focus:border-emerald-500"></p>
                        <button onclick="app.saveStudentName()" class="w-full mt-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 rounded-lg transition duration-150">Simpan Nama</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl card">
                        <h3 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">Pengumuman Hari Ini</h3>
                        <div id="announcements-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <p class="text-sm text-gray-700">Tidak ada pengumuman hari ini.</p>
                            <!-- Jadwal hari ini akan ditampilkan di sini -->
                        </div>
                    </div>
                </div>

                <!-- Soal Per Hari (Ujian Aktif) -->
                <div id="exam-container" class="lg:col-span-2 bg-white p-6 rounded-xl card">
                    <h3 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">Ujian Hari Ini</h3>
                    <div id="active-exams-list" class="space-y-4">
                        <p class="text-gray-500">Memuat ujian yang tersedia hari ini...</p>
                    </div>

                    <!-- Area Ujian -->
                    <div id="exam-area" class="hidden mt-6 pt-4 border-t border-gray-200">
                        <h4 id="exam-title" class="text-2xl font-bold mb-4 text-indigo-700"></h4>
                        <p id="exam-timer" class="text-red-600 text-lg font-semibold mb-4"></p>
                        <form id="quiz-form" class="space-y-6">
                            <!-- Soal akan di-inject di sini -->
                        </form>
                        <button onclick="app.submitExam()" id="submit-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150">Kumpulkan Jawaban</button>
                    </div>
                    
                    <div id="exam-submitted" class="hidden mt-6 p-6 bg-green-50 text-green-700 rounded-lg">
                        <h4 class="font-bold text-xl mb-2">Ujian Selesai!</h4>
                        <p>Jawaban Anda telah berhasil dikumpulkan. Nilai akan diumumkan oleh Admin.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal untuk Menambah Admin 2 -->
    <div id="proctor-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl card max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">Tambahkan Admin 2 (Proktor)</h3>
            <form id="add-proctor-form" class="space-y-4">
                <input type="text" id="proctor-uid" placeholder="UID Admin 2 (Untuk Demo: Random ID)" class="w-full p-3 border rounded-lg" required>
                <input type="text" id="proctor-name" placeholder="Nama Proktor/Guru" class="w-full p-3 border rounded-lg" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">Tambahkan Proktor</button>
            </form>
            <button onclick="app.closeProctorModal()" class="w-full mt-4 text-gray-600 hover:text-gray-800 py-2">Batal</button>
        </div>
    </div>


    <script type="module">
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'projectone-4016f';
        // Menggunakan konfigurasi default untuk demo Realtime Database
        const firebaseConfig = {
            apiKey: "", // Disediakan oleh platform di runtime
            authDomain: `${appId}.firebaseapp.com`,
            databaseURL: `https://${appId}-default-rtdb.asia-southeast1.firebasedatabase.app`, // Contoh URL
            projectId: appId,
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Menggunakan versi Firebase standar 11.6.1 untuk stabilitas platform
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Global Firebase instances
        let appInstance, db, auth, userId = null;
        let userRole = localStorage.getItem('userRole') || null;
        let userName = localStorage.getItem('userName') || '';

        // State global
        let allSubjects = {};
        let allUsers = {};
        let allResults = {};
        let proctorSubjectId = null; // Mapel yang dikelola Admin 2
        let currentExam = null; // Mapel ujian yang sedang dikerjakan siswa
        let examTimerInterval = null;

        const DOM = {
            loading: document.getElementById('loading'),
            roleSelector: document.getElementById('role-selector'),
            admin1Panel: document.getElementById('admin1-panel'),
            admin2Panel: document.getElementById('admin2-panel'),
            studentPanel: document.getElementById('student-panel'),
            userDisplay: document.getElementById('user-display'),
            userIdDisplay: document.getElementById('user-id-display'),
            // Admin 1 elements
            scheduleForm: document.getElementById('schedule-form'),
            proctorSelect: document.getElementById('subject-proctor'),
            subjectsList: document.getElementById('subjects-list'),
            proctorList: document.getElementById('proctor-list'),
            proctorModal: document.getElementById('proctor-modal'),
            addProctorForm: document.getElementById('add-proctor-form'),
            recapHeaderSubjects: document.getElementById('recap-header-subjects'),
            recapBody: document.getElementById('recap-body'),
            // Admin 2 elements
            proctorSubjectInfo: document.getElementById('proctor-subject-info'),
            questionForm: document.getElementById('question-form'),
            qCount: document.getElementById('q-count'),
            qListCount: document.getElementById('q-list-count'),
            questionsList: document.getElementById('questions-list'),
            recapMapelTitle: document.getElementById('recap-mapel-title'),
            admin2RecapBody: document.getElementById('admin2-recap-body'),
            // Student elements
            studentProfileUid: document.getElementById('student-profile-uid'),
            studentNameInput: document.getElementById('student-name-input'),
            announcementsList: document.getElementById('announcements-list'),
            activeExamsList: document.getElementById('active-exams-list'),
            examContainer: document.getElementById('exam-container'),
            examArea: document.getElementById('exam-area'),
            examTitle: document.getElementById('exam-title'),
            examTimer: document.getElementById('exam-timer'),
            quizForm: document.getElementById('quiz-form'),
            examSubmitted: document.getElementById('exam-submitted'),
        };

        const API = {
            async init() {
                try {
                    // 1. Inisialisasi Firebase
                    appInstance = initializeApp(firebaseConfig);
                    auth = getAuth(appInstance);
                    db = getDatabase(appInstance);

                    // 2. Otentikasi (menggunakan token kustom/anonim dari lingkungan)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }

                    // 3. Menyiapkan listener Auth
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            DOM.userIdDisplay.textContent = `UID: ${userId}`;
                            API.setupRealtimeListeners();
                            API.renderApp();
                        } else {
                            // Jika logout atau gagal, tampilkan selector peran
                            API.renderApp(true);
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization or Auth Error:", error);
                    alert("Terjadi kesalahan saat inisialisasi Firebase. Lihat konsol untuk detail.");
                    DOM.loading.textContent = "Gagal memuat aplikasi.";
                }
            },

            // Fungsi untuk mendapatkan path DB yang benar
            getDbPath(path) {
                // Realtime DB tidak menggunakan format /artifacts/{appId}/users/{userId}/...
                // Kita gunakan path sederhana di root untuk demo, atau sesuaikan jika menggunakan struktur kompleks
                return `/${path}`;
            },

            setupRealtimeListeners() {
                // Listener untuk semua Users (diperlukan Admin 1 & 2)
                onValue(ref(db, API.getDbPath('users')), (snapshot) => {
                    allUsers = snapshot.val() || {};
                    if (userRole === 'admin1') { API.renderAdmin1Proctors(); }
                    if (userRole === 'student') { API.renderStudentProfile(); }
                    API.renderApp(); // Render ulang jika data user berubah
                });

                // Listener untuk Subjects (diperlukan semua peran)
                onValue(ref(db, API.getDbPath('subjects')), (snapshot) => {
                    allSubjects = snapshot.val() || {};
                    if (userRole === 'admin1') { API.renderAdmin1Subjects(); }
                    if (userRole === 'student') { API.renderStudentPanel(); }
                    if (userRole === 'admin2') { API.renderAdmin2Panel(); }
                    API.renderApp(); // Render ulang
                });

                // Listener untuk Results (diperlukan Admin 1 & 2)
                onValue(ref(db, API.getDbPath('results')), (snapshot) => {
                    allResults = snapshot.val() || {};
                    if (userRole === 'admin1') { API.renderAdmin1Recap(); }
                    if (userRole === 'admin2') { API.renderAdmin2Recap(); }
                });
            },

            // === UI Rendering & State Management ===
            renderApp(showRoleSelector = false) {
                DOM.loading.classList.add('hidden');

                if (showRoleSelector || !userRole) {
                    DOM.roleSelector.classList.remove('hidden');
                    DOM.admin1Panel.classList.add('hidden');
                    DOM.admin2Panel.classList.add('hidden');
                    DOM.studentPanel.classList.add('hidden');
                    DOM.userDisplay.textContent = 'Mode: Belum Dipilih';
                    return;
                }

                DOM.roleSelector.classList.add('hidden');
                DOM.userDisplay.textContent = `Mode: ${userRole.toUpperCase()} (${userName || userId})`;
                
                DOM.admin1Panel.classList.add('hidden');
                DOM.admin2Panel.classList.add('hidden');
                DOM.studentPanel.classList.add('hidden');

                if (userRole === 'admin1') {
                    DOM.admin1Panel.classList.remove('hidden');
                    API.renderAdmin1Proctors();
                    API.renderAdmin1Subjects();
                    API.renderAdmin1Recap();
                } else if (userRole === 'admin2') {
                    DOM.admin2Panel.classList.remove('hidden');
                    API.renderAdmin2Panel();
                } else if (userRole === 'student') {
                    DOM.studentPanel.classList.remove('hidden');
                    API.renderStudentPanel();
                }
            },

            // --- Admin 1 Logic ---
            renderAdmin1Proctors() {
                DOM.proctorList.innerHTML = '';
                DOM.proctorSelect.innerHTML = '<option value="">Pilih Proktor/Admin 2 (Opsional)</option>';

                Object.keys(allUsers).filter(uid => allUsers[uid].role === 'admin2').forEach(uid => {
                    const user = allUsers[uid];
                    DOM.proctorList.innerHTML += `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                            <p class="text-sm font-medium">${user.name || 'Proktor Baru'} <span class="text-xs text-gray-500">(${uid})</span></p>
                            <button onclick="app.deleteUser('${uid}')" class="text-red-500 hover:text-red-700 text-sm">Hapus</button>
                        </div>
                    `;
                    DOM.proctorSelect.innerHTML += `<option value="${uid}">${user.name} (${uid})</option>`;
                });

                if (DOM.proctorList.innerHTML === '') {
                    DOM.proctorList.innerHTML = '<p class="text-gray-500 text-sm">Belum ada Admin 2 yang terdaftar.</p>';
                }
            },

            renderAdmin1Subjects() {
                DOM.subjectsList.innerHTML = '';
                const subjectKeys = Object.keys(allSubjects);

                if (subjectKeys.length === 0) {
                    DOM.subjectsList.innerHTML = '<p class="text-gray-500 text-sm">Belum ada jadwal ujian yang dibuat.</p>';
                    return;
                }

                subjectKeys.forEach(id => {
                    const subject = allSubjects[id];
                    const proctorName = subject.admin2Uid ? (allUsers[subject.admin2Uid]?.name || 'Proktor Tidak Ditemukan') : 'Belum Ditunjuk';
                    
                    DOM.subjectsList.innerHTML += `
                        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <h4 class="font-bold text-lg">${subject.name} (${id})</h4>
                            <p class="text-sm text-gray-700">Tanggal: ${subject.date}, Waktu: ${subject.startTime} - ${subject.endTime}</p>
                            <p class="text-xs text-gray-600">Proktor: ${proctorName}</p>
                            <div class="mt-2 flex space-x-2">
                                <button onclick="app.deleteSubject('${id}')" class="text-red-500 hover:text-red-700 text-sm">Hapus</button>
                            </div>
                        </div>
                    `;
                });
            },

            renderAdmin1Recap() {
                // 1. Kumpulkan semua siswa
                const studentUids = new Set();
                Object.keys(allResults).forEach(subjectId => {
                    Object.keys(allResults[subjectId]).forEach(uid => studentUids.add(uid));
                });
                
                // 2. Kumpulkan semua mapel untuk header
                const subjectKeys = Object.keys(allSubjects);
                DOM.recapHeaderSubjects.colSpan = subjectKeys.length > 0 ? subjectKeys.length : 1;
                
                // Buat header mapel
                let headerHTML = subjectKeys.map(id => 
                    `<th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">${allSubjects[id].name} (${id})</th>`
                ).join('');
                
                DOM.recapHeaderSubjects.innerHTML = headerHTML || 
                    `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Mata Pelajaran</th>`;
                
                // 3. Isi body rekap
                let bodyHTML = '';
                if (studentUids.size === 0) {
                    bodyHTML = '<tr><td colspan="' + (subjectKeys.length + 1) + '" class="px-3 py-4 text-sm text-gray-500 text-center">Belum ada siswa yang mengerjakan ujian.</td></tr>';
                } else {
                    studentUids.forEach(uid => {
                        const studentName = allUsers[uid]?.name || `Siswa UID: ${uid.substring(0, 8)}...`;
                        let subjectCells = subjectKeys.map(subjectId => {
                            const result = allResults[subjectId] ? allResults[subjectId][uid] : null;
                            const totalQuestions = Object.keys(allSubjects[subjectId]?.questions || {}).length;
                            
                            if (result) {
                                return `<td class="px-3 py-4 whitespace-nowrap text-sm text-center text-green-700 bg-green-50 font-semibold">
                                    ${result.score}/${totalQuestions}
                                </td>`;
                            } else if (totalQuestions > 0) {
                                // Belum mengerjakan
                                return `<td class="px-3 py-4 whitespace-nowrap text-sm text-center text-red-700 bg-red-50">
                                    Belum Mengerjakan
                                </td>`;
                            } else {
                                // Soal belum diinput
                                return `<td class="px-3 py-4 whitespace-nowrap text-sm text-center text-yellow-700 bg-yellow-50">
                                    Soal Belum Ada
                                </td>`;
                            }
                        }).join('');

                        bodyHTML += `
                            <tr>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${studentName}</td>
                                ${subjectCells}
                            </tr>
                        `;
                    });
                }
                DOM.recapBody.innerHTML = bodyHTML;
            },


            // --- Admin 2 Logic ---
            renderAdmin2Panel() {
                const admin2User = allUsers[userId];
                
                // Cek apakah Admin 2 sudah terkait dengan mapel
                let assignedSubjectId = null;
                Object.keys(allSubjects).forEach(id => {
                    if (allSubjects[id].admin2Uid === userId) {
                        assignedSubjectId = id;
                        proctorSubjectId = id; // Set global proctor subject ID
                    }
                });

                if (assignedSubjectId && allSubjects[assignedSubjectId]) {
                    const subject = allSubjects[assignedSubjectId];
                    DOM.proctorSubjectInfo.innerHTML = `Anda mengelola **${subject.name}** (ID: ${assignedSubjectId}).`;
                    DOM.recapMapelTitle.textContent = `${subject.name} (${assignedSubjectId})`;
                    
                    // Listener khusus untuk pertanyaan di mapel ini
                    onValue(ref(db, API.getDbPath(`questions/${assignedSubjectId}`)), (snapshot) => {
                        const questions = snapshot.val() || {};
                        subject.questions = questions; // Update subject data locally
                        API.renderAdmin2Questions(questions, assignedSubjectId);
                        API.renderAdmin2Recap(); // Render ulang rekap saat soal berubah (total soal)
                    });
                } else {
                    DOM.proctorSubjectInfo.innerHTML = `**PERINGATAN:** Anda belum ditunjuk sebagai proktor untuk mata pelajaran apa pun. Harap hubungi Admin Utama.`;
                    DOM.questionsList.innerHTML = `<p class="text-red-500">Tidak dapat menambah soal. Anda belum memiliki mapel yang dikelola.</p>`;
                    proctorSubjectId = null;
                    API.renderAdmin2Recap(true); // Render ulang rekap dengan status tidak tersedia
                }
            },

            renderAdmin2Questions(questions, subjectId) {
                const questionKeys = Object.keys(questions);
                DOM.qCount.textContent = questionKeys.length;
                DOM.qListCount.textContent = questionKeys.length;
                DOM.questionsList.innerHTML = '';

                if (questionKeys.length === 0) {
                    DOM.questionsList.innerHTML = '<p class="text-gray-500">Belum ada soal yang diinput.</p>';
                    return;
                }

                questionKeys.forEach(qId => {
                    const q = questions[qId];
                    const qNum = qId.replace('q', '');
                    DOM.questionsList.innerHTML += `
                        <div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-sm text-indigo-800">Soal No. ${qNum}</p>
                                <button onclick="app.deleteQuestion('${subjectId}', '${qId}')" class="text-red-500 hover:text-red-700 text-xs">Hapus</button>
                            </div>
                            <p class="text-sm mt-1">${q.text.substring(0, 100)}...</p>
                            <p class="text-xs font-semibold mt-1">Kunci: <span class="text-green-600">${q.key.toUpperCase()}</span></p>
                        </div>
                    `;
                });
            },

            renderAdmin2Recap(noSubject = false) {
                if (noSubject || !proctorSubjectId) {
                    DOM.admin2RecapBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-sm text-red-500 text-center">Silakan tentukan mapel yang Anda kelola terlebih dahulu.</td></tr>';
                    return;
                }
                
                const subjectId = proctorSubjectId;
                const results = allResults[subjectId] || {};
                const questions = allSubjects[subjectId]?.questions || {};
                const totalQuestions = Object.keys(questions).length;

                let bodyHTML = '';
                const resultKeys = Object.keys(results);

                if (resultKeys.length === 0) {
                    bodyHTML = '<tr><td colspan="4" class="px-6 py-4 text-sm text-gray-500 text-center">Belum ada siswa yang mengumpulkan ujian mapel ini.</td></tr>';
                } else {
                    resultKeys.forEach(uid => {
                        const result = results[uid];
                        const studentName = allUsers[uid]?.name || `Siswa UID: ${uid.substring(0, 8)}...`;
                        
                        let correctCount = 0;
                        if (totalQuestions > 0) {
                            // Hitung skor
                            Object.keys(result.answers).forEach(qId => {
                                if (questions[qId] && result.answers[qId] === questions[qId].key) {
                                    correctCount++;
                                }
                            });
                            // Update skor di DB jika berbeda
                            if (result.score !== correctCount) {
                                set(ref(db, API.getDbPath(`results/${subjectId}/${uid}/score`)), correctCount);
                            }
                        }

                        bodyHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${studentName} <span class="text-xs text-gray-500">(${uid})</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(result.submissionTime).toLocaleString('id-ID')}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${correctCount}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600">${correctCount}/${totalQuestions}</td>
                            </tr>
                        `;
                    });
                }
                DOM.admin2RecapBody.innerHTML = bodyHTML;
            },


            // --- Student Logic ---
            renderStudentProfile() {
                DOM.studentProfileUid.textContent = userId;
                DOM.studentNameInput.value = userName;
            },

            renderStudentPanel() {
                API.renderStudentProfile(); // Update profile
                API.renderStudentAnnouncements(); // Update announcements/active exams

                if (currentExam) {
                    DOM.activeExamsList.classList.add('hidden');
                    DOM.examArea.classList.remove('hidden');
                    // Render soal jika ada ujian aktif
                    API.renderQuiz(currentExam.subjectId);
                } else {
                    DOM.activeExamsList.classList.remove('hidden');
                    DOM.examArea.classList.add('hidden');
                    DOM.examSubmitted.classList.add('hidden');
                }
            },

            renderStudentAnnouncements() {
                DOM.announcementsList.innerHTML = '';
                DOM.activeExamsList.innerHTML = '';
                
                const today = new Date().toISOString().split('T')[0];
                let todayExams = [];

                Object.keys(allSubjects).forEach(id => {
                    const subject = allSubjects[id];
                    if (subject.date === today) {
                        todayExams.push({ id, ...subject });
                    }
                });

                if (todayExams.length === 0) {
                    DOM.announcementsList.innerHTML = '<p class="text-sm text-gray-700">Tidak ada jadwal ujian hari ini.</p>';
                    DOM.activeExamsList.innerHTML = '<p class="text-gray-500">Tidak ada ujian yang tersedia hari ini.</p>';
                    return;
                }

                // Tampilkan sebagai pengumuman
                todayExams.forEach(exam => {
                    DOM.announcementsList.innerHTML += `
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                            <p class="font-bold text-sm">${exam.name}</p>
                            <p class="text-xs text-gray-600">Pukul: ${exam.startTime} - ${exam.endTime}</p>
                        </div>
                    `;
                });

                // Tampilkan sebagai ujian aktif
                todayExams.forEach(exam => {
                    const result = allResults[exam.id] ? allResults[exam.id][userId] : null;
                    const questions = allSubjects[exam.id]?.questions || {};
                    const totalQuestions = Object.keys(questions).length;

                    let buttonText = 'Mulai Ujian';
                    let statusClass = 'bg-emerald-600 hover:bg-emerald-700';
                    let isDisabled = false;
                    let statusText = '';
                    
                    if (result) {
                        buttonText = 'Sudah Dikerjakan';
                        statusClass = 'bg-gray-400';
                        isDisabled = true;
                        statusText = `<span class="text-xs text-green-600 font-semibold"> (Selesai pada ${new Date(result.submissionTime).toLocaleTimeString('id-ID')})</span>`;
                    } else if (totalQuestions === 0) {
                        buttonText = 'Soal Belum Tersedia';
                        statusClass = 'bg-yellow-500';
                        isDisabled = true;
                    }

                    DOM.activeExamsList.innerHTML += `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-lg">${exam.name} (${exam.id})</h4>
                                <p class="text-sm text-gray-600">Waktu: ${exam.startTime} - ${exam.endTime} ${statusText}</p>
                                <p class="text-xs text-gray-500">Total Soal: ${totalQuestions} pertanyaan.</p>
                            </div>
                            <button ${isDisabled ? 'disabled' : ''} onclick="app.startExam('${exam.id}')" 
                                class="text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ${statusClass} disabled:opacity-50">
                                ${buttonText}
                            </button>
                        </div>
                    `;
                });
            },

            renderQuiz(subjectId) {
                const subject = allSubjects[subjectId];
                if (!subject) return;

                const questions = subject.questions || {};
                const questionKeys = Object.keys(questions);

                DOM.examTitle.textContent = `Ujian: ${subject.name} (${subjectId})`;
                DOM.quizForm.innerHTML = '';
                
                questionKeys.sort((a, b) => parseInt(a.replace('q','')) - parseInt(b.replace('q',''))).forEach((qId, index) => {
                    const q = questions[qId];
                    const qNum = index + 1;
                    
                    let optionsHtml = '';
                    ['a', 'b', 'c', 'd', 'e'].forEach(optKey => {
                        if (q.options[optKey]) {
                            optionsHtml += `
                                <label class="block p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="${qId}" value="${optKey}" class="mr-3 text-emerald-600 focus:ring-emerald-500">
                                    <span class="font-medium uppercase">${optKey}.</span> ${q.options[optKey]}
                                </label>
                            `;
                        }
                    });

                    DOM.quizForm.innerHTML += `
                        <div class="p-6 bg-gray-50 rounded-lg border-l-4 border-emerald-500">
                            <p class="font-bold text-lg mb-3">Soal No. ${qNum} dari ${questionKeys.length}</p>
                            <p class="text-gray-800 mb-4">${q.text}</p>
                            <div class="space-y-2 text-sm">
                                ${optionsHtml}
                            </div>
                        </div>
                    `;
                });
                
                // Mulai timer
                API.startTimer(subject.endTime);
            },

            startTimer(endTime) {
                if (examTimerInterval) clearInterval(examTimerInterval);

                const calculateTimeRemaining = () => {
                    const now = new Date();
                    const end = new Date(`${new Date().toISOString().split('T')[0]}T${endTime}`);
                    const diff = end - now;

                    if (diff <= 0) {
                        clearInterval(examTimerInterval);
                        DOM.examTimer.textContent = "Waktu Habis! Ujian Disubmit Otomatis.";
                        // Jika waktu habis, submit otomatis
                        setTimeout(() => API.submitExam(true), 1000);
                        return '00:00:00';
                    }

                    const hours = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, '0');
                    const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                    const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
                    
                    return `${hours}:${minutes}:${seconds}`;
                };

                DOM.examTimer.textContent = calculateTimeRemaining();
                examTimerInterval = setInterval(() => {
                    DOM.examTimer.textContent = calculateTimeRemaining();
                }, 1000);
            }
        };

        // Exported functions for global use in HTML
        window.app = {
            logout() {
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                userRole = null;
                userName = '';
                if (examTimerInterval) clearInterval(examTimerInterval);
                API.renderApp(true);
            },

            setRole(role) {
                localStorage.setItem('userRole', role);
                userRole = role;
                // Untuk demo, jika student, set nama anonim
                if (role === 'student' && !userName) {
                    const defaultName = 'Siswa Anonim ' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('userName', defaultName);
                    userName = defaultName;
                }
                API.renderApp();
            },

            saveStudentName() {
                const name = DOM.studentNameInput.value.trim();
                if (name) {
                    localStorage.setItem('userName', name);
                    userName = name;
                    set(ref(db, API.getDbPath(`users/${userId}/name`)), name)
                        .then(() => alert('Nama berhasil disimpan di database.'))
                        .catch(err => console.error(err));
                }
            },

            // --- Admin 1 Actions ---
            openProctorModal() {
                document.getElementById('proctor-uid').value = crypto.randomUUID().substring(0, 10);
                DOM.proctorModal.classList.remove('hidden');
                DOM.proctorModal.classList.add('flex');
            },
            
            closeProctorModal() {
                DOM.proctorModal.classList.add('hidden');
                DOM.proctorModal.classList.remove('flex');
            },

            deleteSubject(id) {
                if (confirm(`Yakin ingin menghapus jadwal ${id}? Semua data soal dan hasil terkait akan dihapus!`)) {
                    remove(ref(db, API.getDbPath(`subjects/${id}`)));
                    remove(ref(db, API.getDbPath(`questions/${id}`)));
                    remove(ref(db, API.getDbPath(`results/${id}`)));
                }
            },

            deleteUser(uid) {
                if (confirm(`Yakin ingin menghapus user ${uid}?`)) {
                    remove(ref(db, API.getDbPath(`users/${uid}`)));
                }
            },

            // --- Admin 2 Actions ---
            deleteQuestion(subjectId, qId) {
                if (confirm(`Yakin ingin menghapus soal ${qId}?`)) {
                    remove(ref(db, API.getDbPath(`questions/${subjectId}/${qId}`)));
                }
            },

            clearQuestions() {
                 if (confirm(`Yakin ingin MENGHAPUS SEMUA ${DOM.recapMapelTitle.textContent} soal Anda?`)) {
                    remove(ref(db, API.getDbPath(`questions/${proctorSubjectId}`)));
                }
            },

            // --- Student Actions ---
            startExam(subjectId) {
                currentExam = { subjectId };
                API.renderStudentPanel();
            },

            submitExam(isAutoSubmit = false) {
                if (!currentExam) return;
                
                const subjectId = currentExam.subjectId;
                const form = DOM.quizForm;
                const questions = allSubjects[subjectId]?.questions || {};
                const totalQuestions = Object.keys(questions).length;
                
                if (!isAutoSubmit && !confirm(`Anda yakin ingin mengumpulkan ujian ${allSubjects[subjectId].name}?`)) return;

                const answers = {};
                let answeredCount = 0;
                
                Object.keys(questions).forEach(qId => {
                    const selected = form.querySelector(`input[name="${qId}"]:checked`);
                    if (selected) {
                        answers[qId] = selected.value;
                        answeredCount++;
                    } else {
                        answers[qId] = 'N/A';
                    }
                });

                if (!isAutoSubmit && answeredCount < totalQuestions / 2 && totalQuestions > 0) {
                     // Gunakan modal kustom atau pesan yang lebih baik daripada alert
                     alert(`Anda baru menjawab ${answeredCount} dari ${totalQuestions} soal. Silakan tinjau kembali sebelum submit.`);
                     return;
                }

                // Hitung skor (Client-side, akan diverifikasi ulang oleh Admin 2)
                let score = 0;
                Object.keys(answers).forEach(qId => {
                    if (questions[qId] && answers[qId] === questions[qId].key) {
                        score++;
                    }
                });
                
                const resultData = {
                    studentName: userName,
                    submissionTime: serverTimestamp(), // Menggunakan timestamp server
                    answers: answers,
                    score: score // Skor awal (hanya untuk informasi cepat, skor resmi dihitung admin)
                };

                // Path: results/{subjectId}/{userId}
                set(ref(db, API.getDbPath(`results/${subjectId}/${userId}`)), resultData)
                    .then(() => {
                        currentExam = null;
                        if (examTimerInterval) clearInterval(examTimerInterval);
                        DOM.examArea.classList.add('hidden');
                        DOM.examSubmitted.classList.remove('hidden');
                        alert(isAutoSubmit ? 'Waktu habis! Jawaban berhasil disubmit otomatis.' : 'Jawaban berhasil dikumpulkan!');
                        API.renderStudentAnnouncements();
                    })
                    .catch(error => {
                        console.error("Submission Error:", error);
                        alert("Gagal mengumpulkan jawaban. Coba lagi.");
                    });
            }
        };

        // --- Event Listeners for Forms ---

        DOM.scheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const subjectId = DOM.scheduleForm.querySelector('#subject-id').value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const subjectData = {
                name: DOM.scheduleForm.querySelector('#subject-name').value,
                date: DOM.scheduleForm.querySelector('#subject-date').value,
                startTime: DOM.scheduleForm.querySelector('#subject-time-start').value,
                endTime: DOM.scheduleForm.querySelector('#subject-time-end').value,
                admin2Uid: DOM.proctorSelect.value || null,
            };

            set(ref(db, API.getDbPath(`subjects/${subjectId}`)), subjectData)
                .then(() => alert(`Jadwal ${subjectId} berhasil disimpan!`))
                .catch(err => console.error(err));
        });

        DOM.addProctorForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const uid = document.getElementById('proctor-uid').value;
            const name = document.getElementById('proctor-name').value;

            const userData = {
                name: name,
                role: 'admin2'
            };

            set(ref(db, API.getDbPath(`users/${uid}`)), userData)
                .then(() => {
                    alert(`${name} berhasil ditambahkan sebagai Admin 2!`);
                    app.closeProctorModal();
                })
                .catch(err => console.error(err));
        });

        DOM.questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!proctorSubjectId) {
                alert('Anda belum memiliki mapel yang dikelola. Gagal menyimpan soal.');
                return;
            }

            const qNum = DOM.questionForm.querySelector('#q-number').value;
            const qId = `q${qNum.padStart(2, '0')}`;
            
            const questionData = {
                text: DOM.questionForm.querySelector('#q-text').value,
                options: {
                    a: DOM.questionForm.querySelector('#opt-a').value,
                    b: DOM.questionForm.querySelector('#opt-b').value,
                    c: DOM.questionForm.querySelector('#opt-c').value,
                    d: DOM.questionForm.querySelector('#opt-d').value,
                },
                key: DOM.questionForm.querySelector('#q-key').value,
            };

            const optE = DOM.questionForm.querySelector('#opt-e').value;
            if (optE) {
                questionData.options.e = optE;
            }
            
            // Limit 55 soal
            if (Object.keys(allSubjects[proctorSubjectId].questions || {}).length >= 55 && !allSubjects[proctorSubjectId].questions[qId]) {
                 alert('Maksimal soal adalah 55. Soal baru gagal disimpan.');
                 return;
            }


            set(ref(db, API.getDbPath(`questions/${proctorSubjectId}/${qId}`)), questionData)
                .then(() => {
                    alert(`Soal No. ${qNum} berhasil disimpan untuk ${proctorSubjectId}!`);
                    DOM.questionForm.reset();
                    // Lanjutkan ke nomor berikutnya secara otomatis
                    DOM.questionForm.querySelector('#q-number').value = parseInt(qNum) + 1;
                })
                .catch(err => console.error(err));
        });

        // Inisialisasi Aplikasi
        window.onload = API.init;
    </script>
</body>
</html>