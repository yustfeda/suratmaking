<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Online & Mystery Box</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for animated hamburger menu */
        .hamburger-menu {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 24px;
            height: 20px;
            cursor: pointer;
        }
        .bar {
            height: 3px;
            width: 100%;
            background-color: #374151;
            border-radius: 9999px;
            transition: all 0.3s ease-in-out;
        }
        .menu-open .bar:nth-child(1) {
            transform: translateY(8.5px) rotate(45deg);
        }
        .menu-open .bar:nth-child(2) {
            opacity: 0;
        }
        .menu-open .bar:nth-child(3) {
            transform: translateY(-8.5px) rotate(-45deg);
        }
        /* Style for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Main Header -->
        <header class="bg-white shadow-md sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="#" class="text-2xl font-bold text-indigo-600" onclick="App.setView('userHome'); return false;">TokoID</a>

                    <!-- Desktop Navigation -->
                    <nav id="desktop-nav" class="hidden sm:block">
                        <div class="flex space-x-4">
                            <!-- Nav links rendered by JS -->
                        </div>
                    </nav>

                    <!-- Hamburger Menu Button (Mobile) -->
                    <div class="sm:hidden flex items-center space-x-4">
                        <button id="admin-switch-btn" class="text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full hover:bg-gray-200 transition">
                            Admin
                        </button>
                        <button id="hamburger-btn" class="hamburger-menu transition-all duration-300">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </button>
                    </div>

                    <!-- Desktop Admin Button -->
                    <button id="admin-switch-btn-desktop" class="hidden sm:block text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full hover:bg-gray-200 transition" onclick="App.toggleAdminView()">
                        Admin View
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile Sidebar -->
        <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white z-40 transform -translate-x-full transition-transform duration-300 shadow-xl sm:hidden pt-16">
            <nav class="p-4">
                <!-- Mobile Nav links rendered by JS -->
            </nav>
        </div>
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden sm:hidden" onclick="App.closeSidebar()"></div>

        <!-- Main Content Area -->
        <main id="content-area" class="flex-grow max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">
            <!-- Content will be rendered here by JavaScript -->
            <div class="text-center py-20 text-gray-500">Memuat aplikasi...</div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 border-t mt-8">
            <div class="max-w-7xl mx-auto p-4 text-center text-sm text-gray-500">
                &copy; 2024 TokoID. Dibuat dengan Gemini. | User ID: <span id="current-user-id">Memuat...</span>
            </div>
        </footer>

        <!-- Modal Container -->
        <div id="modal-container">
            <!-- Modals will be injected here -->
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL FIREBASE CONFIGURATION (MANDATORY) ---
        // These global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Hardcoded ADMIN_UID (The user who is currently signed in should be the admin for a simple setup)
        // This will be set after successful authentication.
        let ADMIN_USER_ID = null;

        // Firestore paths
        const COLLECTIONS = {
            PRODUCTS: 'products',
            MB_PLAYS: 'mysteryBoxPlays',
        };

        // --- Core Application Class ---
        class StoreApp {
            constructor() {
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.isAuthReady = false;
                this.isAdmin = false;
                this.currentView = 'userHome'; // userHome | userProducts | userMB | adminProducts | adminMB
                this.products = [];
                this.mbPlays = [];
                this.userIP = null;
                this.isSidebarOpen = false;
                this.initApp();
            }

            async initApp() {
                try {
                    // 1. Initialize Firebase
                    if (Object.keys(firebaseConfig).length === 0) {
                         throw new Error("Firebase config not found.");
                    }
                    setLogLevel('debug'); // Enable Firestore logs
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    window.App = this; // Make the App instance globally accessible

                    // 2. Fetch User IP Address
                    await this.fetchUserIP();

                    // 3. Handle Authentication
                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.userId = user.uid;
                            document.getElementById('current-user-id').textContent = user.uid;
                            ADMIN_USER_ID = user.uid; // Set the current user as the Admin initially

                            // Check if the current user is the admin
                            this.isAdmin = (this.userId === ADMIN_USER_ID);

                        } else {
                            // This part should not be reached if signInWithCustomToken is successful
                            this.userId = 'anonymous';
                            document.getElementById('current-user-id').textContent = 'ANONYMOUS';
                            this.isAdmin = false;
                        }

                        this.isAuthReady = true;
                        this.setupListeners(); // Start listening to database changes only after auth
                        this.renderNavigation();
                        this.renderView();
                    });

                    // Sign in using custom token or anonymously
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(this.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(this.auth);
                    }

                } catch (error) {
                    console.error("Error initializing Firebase or Auth:", error);
                    document.getElementById('content-area').innerHTML = `<div class="text-center text-red-600 py-20">Gagal memuat aplikasi. Cek konsol untuk detail error.</div>`;
                }
            }

            async fetchUserIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    this.userIP = data.ip;
                    console.log('User IP Address:', this.userIP);
                } catch (error) {
                    console.error("Gagal mendapatkan IP Address:", error);
                    this.userIP = 'IP_NOT_FOUND';
                }
            }

            // --- Database Listeners ---
            setupListeners() {
                if (!this.db || !this.isAuthReady) return;

                // 1. Products Listener (Public Data)
                const productsPath = this.getPublicCollectionRef(COLLECTIONS.PRODUCTS);
                onSnapshot(productsPath, (snapshot) => {
                    this.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderView(); // Re-render whenever products change
                }, (error) => {
                    console.error("Error fetching products:", error);
                });

                // 2. Mystery Box Plays Listener (Public Data)
                const mbPlaysPath = this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS);
                onSnapshot(mbPlaysPath, (snapshot) => {
                    this.mbPlays = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderView(); // Re-render whenever MB plays change
                }, (error) => {
                    console.error("Error fetching MB Plays:", error);
                });
            }

            // --- Firestore Helpers ---
            getPublicCollectionRef(collectionName) {
                return collection(this.db, `artifacts/${appId}/public/data/${collectionName}`);
            }
            getAdminCollectionRef(collectionName) {
                // Admin data is stored under the admin user's private path for security/management
                return collection(this.db, `artifacts/${appId}/users/${ADMIN_USER_ID}/${collectionName}`);
            }
            getMbPlayByIp(ipAddress) {
                return this.mbPlays.find(play => play.ipAddress === ipAddress);
            }
            getUserMbPlays() {
                // Filter plays for the current IP and check if the user has completed the payment flow.
                return this.mbPlays.filter(play => play.ipAddress === this.userIP);
            }

            // --- UI/View Management ---
            toggleSidebar() {
                this.isSidebarOpen = !this.isSidebarOpen;
                document.getElementById('mobile-sidebar').classList.toggle('-translate-x-full', !this.isSidebarOpen);
                document.getElementById('mobile-overlay').classList.toggle('hidden', !this.isSidebarOpen);
                document.getElementById('hamburger-btn').classList.toggle('menu-open', this.isSidebarOpen);
            }

            closeSidebar() {
                this.isSidebarOpen = false;
                document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-overlay').classList.add('hidden');
                document.getElementById('hamburger-btn').classList.remove('menu-open');
            }

            toggleAdminView() {
                this.isAdmin = !this.isAdmin;
                if (this.isAdmin) {
                    this.currentView = 'adminProducts';
                } else {
                    this.currentView = 'userHome';
                }
                this.renderNavigation();
                this.renderView();
                this.closeSidebar();
            }

            setView(viewName) {
                this.currentView = viewName;
                this.renderView();
                this.closeSidebar();
            }

            renderNavigation() {
                const navLinks = this.isAdmin ? this.renderAdminNav() : this.renderUserNav();

                document.getElementById('desktop-nav').querySelector('div').innerHTML = navLinks.join('');
                document.getElementById('mobile-sidebar').querySelector('nav').innerHTML = navLinks.join('');

                // Update admin switch button text
                const adminBtn = document.getElementById('admin-switch-btn-desktop');
                if (adminBtn) adminBtn.textContent = this.isAdmin ? 'User View' : 'Admin View';
                const adminBtnMobile = document.getElementById('admin-switch-btn');
                if (adminBtnMobile) adminBtnMobile.textContent = this.isAdmin ? 'User View' : 'Admin View';
            }

            renderUserNav() {
                return [
                    { name: 'Beranda', view: 'userHome' },
                    { name: 'Dijual', view: 'userProducts' },
                    { name: 'Mystery Box', view: 'userMB' },
                    { name: 'Leaderboard', view: 'userLeaderboard' }
                ].map(item => `
                    <a href="#" onclick="App.setView('${item.view}'); return false;"
                       class="px-3 py-2 rounded-md text-sm font-medium transition ${this.currentView === item.view ? 'bg-indigo-500 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                        ${item.name}
                    </a>
                `);
            }

            renderAdminNav() {
                return [
                    { name: 'Kelola Produk', view: 'adminProducts' },
                    { name: 'Kelola Mystery Box', view: 'adminMB' }
                ].map(item => `
                    <a href="#" onclick="App.setView('${item.view}'); return false;"
                       class="px-3 py-2 rounded-md text-sm font-medium transition ${this.currentView === item.view ? 'bg-indigo-500 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                        ${item.name}
                    </a>
                `);
            }

            renderView() {
                const contentArea = document.getElementById('content-area');
                if (!this.isAuthReady) {
                    contentArea.innerHTML = this.renderLoading();
                    return;
                }

                if (this.isAdmin) {
                    // Render Admin Views
                    switch (this.currentView) {
                        case 'adminProducts':
                            contentArea.innerHTML = this.renderAdminProducts();
                            this.renderProductList();
                            break;
                        case 'adminMB':
                            contentArea.innerHTML = this.renderAdminMB();
                            this.renderMBPlayList();
                            break;
                        default:
                            this.currentView = 'adminProducts';
                            contentArea.innerHTML = this.renderAdminProducts();
                            this.renderProductList();
                    }
                } else {
                    // Render User Views
                    switch (this.currentView) {
                        case 'userProducts':
                            contentArea.innerHTML = this.renderUserProducts();
                            break;
                        case 'userMB':
                            contentArea.innerHTML = this.renderUserMB();
                            break;
                        case 'userLeaderboard':
                            contentArea.innerHTML = this.renderUserLeaderboard();
                            break;
                        case 'userHome':
                        default:
                            this.currentView = 'userHome';
                            contentArea.innerHTML = this.renderUserHome();
                    }
                }
                // Ensure icons are rendered
                lucide.createIcons();
            }

            renderLoading() {
                return `
                    <div class="flex flex-col items-center justify-center py-20">
                        <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-gray-600">Sedang memuat data dan mengautentikasi...</p>
                    </div>
                `;
            }

            // --- MODALS ---
            showModal(id, title, body, footer = '') {
                const modalHtml = `
                    <div id="${id}" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="App.hideModal('${id}')">
                        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transition-all duration-300 transform scale-100" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center border-b pb-3 mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                                <button onclick="App.hideModal('${id}')" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div class="text-gray-700">
                                ${body}
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                ${footer}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').innerHTML = modalHtml;
                lucide.createIcons();
            }

            hideModal(id) {
                const modal = document.getElementById(id);
                if (modal) modal.remove();
            }

            // --- USER VIEWS ---

            renderUserHome() {
                const productGroups = this.products.reduce((acc, product) => {
                    acc[product.category] = (acc[product.category] || 0) + 1;
                    return acc;
                }, {});

                const categoryList = Object.entries(productGroups).map(([category, count]) => `
                    <li class="flex justify-between items-center p-4 bg-white rounded-lg shadow-md border-l-4 border-indigo-500">
                        <span class="text-lg font-medium text-gray-700">${category}</span>
                        <span class="text-2xl font-bold text-indigo-600">${count}</span>
                    </li>
                `).join('');

                const productCount = this.products.length;
                const totalStock = this.products.reduce((sum, p) => sum + (p.stock || 0), 0);

                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Selamat Datang di TokoID</h1>
                    <p class="text-gray-600 mb-8">Beranda menampilkan rangkuman cepat barang yang kami jual.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="package" class="w-8 h-8"></i>
                                <h3 class="text-xl font-semibold">Total Jenis Produk</h3>
                            </div>
                            <p class="text-4xl font-extrabold mt-2">${Object.keys(productGroups).length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <div class="flex items-center space-x-3 text-gray-700">
                                <i data-lucide="tag" class="w-8 h-8 text-indigo-500"></i>
                                <h3 class="text-xl font-semibold">Total Barang Dijual</h3>
                            </div>
                            <p class="text-4xl font-extrabold mt-2 text-indigo-600">${productCount}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <div class="flex items-center space-x-3 text-gray-700">
                                <i data-lucide="stock-line" class="w-8 h-8 text-green-500"></i>
                                <h3 class="text-xl font-semibold">Total Stok Tersedia</h3>
                            </div>
                            <p class="text-4xl font-extrabold mt-2 text-green-600">${totalStock}</p>
                        </div>
                    </div>

                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Rangkuman Berdasarkan Jenis Barang</h2>
                    <ul class="space-y-4">
                        ${categoryList.length > 0 ? categoryList : '<li class="text-gray-500">Belum ada data produk. Silahkan tambah melalui menu Admin.</li>'}
                    </ul>
                `;
            }

            renderUserProducts() {
                const productCards = this.products.filter(p => p.stock > 0).map(product => `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition-all duration-300 hover:shadow-xl">
                        <img src="${product.imageUrl || 'https://placehold.co/400x300/a5b4fc/1e3a8a?text=Produk'}"
                             alt="${product.name}" class="w-full h-48 object-cover object-center"
                             onerror="this.onerror=null;this.src='https://placehold.co/400x300/a5b4fc/1e3a8a?text=Produk Placeholder';"
                        >
                        <div class="p-5 flex-grow">
                            <p class="text-sm font-medium text-indigo-600 mb-1">${product.category}</p>
                            <h3 class="text-xl font-bold text-gray-800 line-clamp-2">${product.name}</h3>
                            <p class="text-3xl font-extrabold text-green-600 mt-2">Rp ${this.formatRupiah(product.price)}</p>
                            <p class="text-sm text-gray-500 mt-1">Stok: ${product.stock}</p>
                        </div>
                        <div class="p-5 border-t">
                            <button onclick="App.handleBuyProduct('${product.id}', '${product.buyLink}')"
                                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors shadow-md shadow-indigo-300">
                                Beli Sekarang
                            </button>
                        </div>
                    </div>
                `).join('');

                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-2">Semua Barang Dijual</h1>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        ${productCards.length > 0 ? productCards : '<p class="col-span-full text-center text-gray-500 p-10 bg-white rounded-xl">Saat ini tidak ada produk yang tersedia. Cek lagi nanti!</p>'}
                    </div>
                `;
            }

            async handleBuyProduct(productId, buyLink) {
                if (!this.db || !this.isAuthReady) {
                    this.showModal('auth-error', 'Kesalahan', 'Autentikasi belum selesai. Silakan coba lagi.');
                    return;
                }

                const productRef = doc(this.getPublicCollectionRef(COLLECTIONS.PRODUCTS), productId);

                try {
                    await runTransaction(this.db, async (transaction) => {
                        const productDoc = await transaction.get(productRef);
                        if (!productDoc.exists()) {
                            throw "Produk tidak ditemukan!";
                        }

                        const currentStock = productDoc.data().stock;
                        if (currentStock <= 0) {
                            throw "Maaf, stok barang ini sudah habis.";
                        }

                        // Kurangi stok
                        transaction.update(productRef, { stock: currentStock - 1 });
                    });

                    // Sukses mengurangi stok, alihkan ke link CTA
                    window.open(buyLink, '_blank');
                    this.showModal('buy-success', 'Pembelian Berhasil!', `
                        <p>Stok berhasil dikurangi. Anda akan diarahkan ke halaman pembayaran/CTA.</p>
                        <p class="mt-2 text-sm text-gray-500">Pastikan Anda menyelesaikan transaksi di halaman tujuan.</p>
                    `, `<button onclick="App.hideModal('buy-success')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg">OK</button>`);

                } catch (error) {
                    console.error("Gagal melakukan pembelian:", error);
                    this.showModal('buy-error', 'Gagal Beli', `<p>${error}</p>`, `<button onclick="App.hideModal('buy-error')" class="bg-red-500 text-white px-4 py-2 rounded-lg">Tutup</button>`);
                }
            }

            renderUserMB() {
                if (!this.userIP) {
                    return `<div class="text-center p-10 text-gray-500">Gagal mendapatkan IP Anda. Tidak bisa memainkan Mystery Box.</div>`;
                }

                const userPlays = this.getUserMbPlays();
                const currentPlay = userPlays.find(p => !p.hasOpened && p.isApproved);
                const isWaitingPaymentProof = userPlays.find(p => !p.isApproved && !p.isPaidProofSent);
                const isWaitingAdminApproval = userPlays.find(p => !p.isApproved && p.isPaidProofSent);
                const hasOpenedToday = userPlays.some(p => {
                    const playDate = new Date(p.timestamp);
                    const today = new Date();
                    return playDate.toDateString() === today.toDateString() && p.hasOpened;
                });

                let actionSection;

                if (currentPlay) {
                    // State: Approved, Ready to Open
                    actionSection = `
                        <p class="text-center text-green-600 font-semibold text-lg mb-4">SELAMAT! Bukti pembayaran Anda telah dikonfirmasi oleh Admin. Anda sekarang dapat membuka Mystery Box!</p>
                        <button onclick="App.handleOpenMysteryBox('${currentPlay.id}')"
                                class="w-full bg-green-500 text-white font-bold text-xl py-4 rounded-xl hover:bg-green-600 transition-colors shadow-lg shadow-green-300 transform hover:scale-[1.02]">
                            <i data-lucide="gift" class="w-6 h-6 inline mr-2"></i> BUKA MYSTERY BOX SEKARANG!
                        </button>
                    `;
                } else if (isWaitingAdminApproval) {
                    // State: Sent Proof, Waiting Approval
                    actionSection = `
                        <div class="text-center p-6 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg">
                            <i data-lucide="clock" class="w-8 h-8 mx-auto mb-3"></i>
                            <p class="font-bold text-lg">Menunggu Konfirmasi Admin</p>
                            <p>Anda telah mengirimkan bukti pembayaran. Admin sedang memprosesnya. Mohon tunggu notifikasi untuk bisa membuka Mystery Box.</p>
                        </div>
                    `;
                } else if (isWaitingPaymentProof) {
                    // State: Played (redirected) but hasn't sent proof (This is only triggered after 'Beli' click)
                    actionSection = `
                        <div class="text-center p-6 bg-red-100 border border-red-400 text-red-800 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-3"></i>
                            <p class="font-bold text-lg">TINDAKAN DIBUTUHKAN</p>
                            <p>Anda telah melakukan pembelian Mystery Box, namun belum mengirimkan bukti pembayaran.</p>
                            <button onclick="App.showPaymentProofModal('${isWaitingPaymentProof.id}')"
                                    class="mt-4 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
                                Kirim Bukti Bayar Sekarang
                            </button>
                        </div>
                    `;
                } else if (hasOpenedToday) {
                     // State: Has opened a box today (or just opened, and lost)
                     actionSection = `
                        <div class="text-center p-6 bg-gray-100 border border-gray-400 text-gray-800 rounded-lg">
                            <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-3"></i>
                            <p class="font-bold text-lg">Coba Lagi Besok</p>
                            <p>Anda sudah bermain Mystery Box. Silakan coba lagi besok untuk kesempatan menang yang baru!</p>
                        </div>
                    `;
                } else {
                    // State: Fresh player or has finished previous play
                    actionSection = `
                        <p class="text-center text-gray-700 mb-4">Klik tombol di bawah untuk membeli Mystery Box dan memulai permainan!</p>
                        <button onclick="App.handleBuyMysteryBox()"
                                class="w-full bg-indigo-600 text-white font-bold text-xl py-4 rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-300 transform hover:scale-[1.02]">
                            <i data-lucide="shopping-cart" class="w-6 h-6 inline mr-2"></i> BELI MYSTERY BOX
                        </button>
                    `;
                }

                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-2">Mystery Box Berhadiah Baju</h1>
                    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl border-4 border-indigo-400">
                        <div class="text-center mb-6">
                            <i data-lucide="package" class="w-20 h-20 text-indigo-600 mx-auto"></i>
                            <h2 class="text-2xl font-extrabold text-gray-800 mt-3">Raih Kesempatan Menang!</h2>
                            <p class="text-gray-500">Mistery Box berisi baju dan *balik lagi*. Pemenang diundi berdasarkan IP Address Anda!</p>
                            <p class="text-xs text-gray-400 mt-1">IP Anda: ${this.userIP}</p>
                        </div>
                        ${actionSection}
                    </div>
                `;
            }

            async handleBuyMysteryBox() {
                if (!this.db || !this.isAuthReady || !this.userIP) return;

                // 1. Catat permainan baru di database
                const newPlay = {
                    ipAddress: this.userIP,
                    userId: this.userId,
                    timestamp: new Date().toISOString(),
                    isPaidProofSent: false, // Menunggu bukti bayar
                    isApproved: false, // Menunggu konfirmasi admin
                    isWinner: false, // Status awal
                    hasOpened: false, // Belum dibuka
                };

                try {
                    const docRef = await addDoc(this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS), newPlay);

                    // 2. Redirect ke link pembayaran (Call to action ke link lain)
                    const externalLink = 'https://wa.me/6285817938860?text=Saya%20ingin%20membeli%20Mystery%20Box%20%28ID%3A%20' + docRef.id + '%29';
                    window.open(externalLink, '_blank');

                    // 3. Tampilkan modal untuk mengirim bukti bayar
                    this.showPaymentProofModal(docRef.id);

                } catch (error) {
                    console.error("Gagal mencatat Mystery Box Play:", error);
                    this.showModal('mb-buy-error', 'Gagal', 'Terjadi kesalahan saat memulai Mystery Box. Coba lagi.');
                }
            }

            showPaymentProofModal(playId) {
                const waLink = 'https://wa.me/6285817938860?text=Admin%2C%20ini%20bukti%20pembayaran%20Mystery%20Box%20saya%20dengan%20Play%20ID%3A%20' + playId;
                this.showModal('payment-proof-modal', 'Kirim Bukti Pembayaran', `
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li>Silakan kirim bukti bayar Mystery Box ke Admin.</li>
                        <li>Setelah berhasil terkirim, tunggu konfirmasi dari Admin.</li>
                        <li>Setelah dikonfirmasi (diceklis oleh Admin), Anda bisa menggunakan token/akses untuk membuka Mystery Box.</li>
                    </ol>
                    <div class="mt-4 text-center">
                        <p class="text-sm font-semibold text-gray-600 mb-2">WA Admin: 085817938860</p>
                        <button onclick="App.handlePaymentProofSent('${playId}')"
                                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition shadow-md">
                            <i data-lucide="whatsapp" class="w-5 h-5 inline mr-2"></i> KONFIRMASI KIRIM BUKTI
                        </button>
                    </div>
                `, `<button onclick="App.hideModal('payment-proof-modal')" class="bg-gray-400 text-white px-4 py-2 rounded-lg">Tutup</button>`);
                lucide.createIcons();
            }

            async handlePaymentProofSent(playId) {
                if (!this.db || !this.isAuthReady) return;

                try {
                    const playRef = doc(this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS), playId);
                    await updateDoc(playRef, { isPaidProofSent: true });

                    this.hideModal('payment-proof-modal');
                    this.showModal('proof-sent-success', 'Terkirim!', 'Bukti bayar Anda telah dicatat. Mohon tunggu konfirmasi dari Admin sebelum membuka Mystery Box.');
                    this.setView('userMB');

                } catch (error) {
                    console.error("Gagal update bukti bayar:", error);
                }
            }

            async handleOpenMysteryBox(playId) {
                if (!this.db || !this.isAuthReady) return;

                try {
                    const playRef = doc(this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS), playId);
                    const playDoc = await getDoc(playRef);

                    if (!playDoc.exists() || playDoc.data().hasOpened) {
                        this.showModal('mb-error', 'Kesalahan', 'Box sudah dibuka atau ID tidak valid.');
                        return;
                    }

                    const playData = playDoc.data();

                    // Update status telah dibuka
                    await updateDoc(playRef, { hasOpened: true });

                    // Tampilkan hasil
                    if (playData.isWinner) {
                        this.showModal('mb-win', 'SELAMAT! ANDA MENANG!', `
                            <div class="text-center p-4">
                                <i data-lucide="award" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
                                <p class="text-xl font-bold text-gray-800">Anda berhasil memenangkan VOUCHER TUKAR BAJU!</p>
                                <p class="mt-4">Silakan **screenshot** notifikasi ini dan kirimkan ke Admin (WA: 085817938860) untuk klaim hadiah Anda.</p>
                                <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                                    <p class="font-mono text-lg text-indigo-700">VOUCHER-${Math.random().toString(36).substring(2, 10).toUpperCase()}</p>
                                </div>
                            </div>
                        `, `<button onclick="App.hideModal('mb-win')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg">Tutup</button>`);
                    } else {
                        this.showModal('mb-lose', 'Coba Lagi Nanti :(', `
                            <div class="text-center p-4">
                                <i data-lucide="sad" class="w-12 h-12 text-gray-500 mx-auto mb-4"></i>
                                <p class="text-xl font-bold text-gray-800">Maaf, Anda belum beruntung.</p>
                                <p class="mt-2">Coba lagi di Mystery Box selanjutnya untuk kesempatan menang!</p>
                            </div>
                        `, `<button onclick="App.hideModal('mb-lose')" class="bg-red-500 text-white px-4 py-2 rounded-lg">Tutup</button>`);
                    }
                    this.setView('userMB'); // Re-render the MB page
                } catch (error) {
                    console.error("Gagal membuka Mystery Box:", error);
                    this.showModal('mb-open-error', 'Gagal', 'Terjadi kesalahan saat membuka Box. Coba lagi.');
                }
            }

            renderUserLeaderboard() {
                // Filter pemenang dan hitung jumlah kemenangan per user/IP
                const winners = this.mbPlays.filter(p => p.isApproved && p.isWinner);
                const winCounts = winners.reduce((acc, play) => {
                    const key = play.ipAddress;
                    acc[key] = (acc[key] || { count: 0, userId: play.userId });
                    acc[key].count++;
                    return acc;
                }, {});

                const leaderboardData = Object.entries(winCounts)
                    .map(([ip, data]) => ({ ip, count: data.count, userId: data.userId }))
                    .sort((a, b) => b.count - a.count);

                const leaderboardRows = leaderboardData.map((item, index) => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-bold text-lg text-center">${index + 1}</td>
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.ip}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 hidden sm:table-cell">${item.userId}</td>
                        <td class="px-6 py-4 font-bold text-center text-indigo-600">${item.count}</td>
                    </tr>
                `).join('');

                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-2">Leaderboard Pemenang Mystery Box</h1>
                    <div class="overflow-x-auto shadow-md rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-center">Peringkat</th>
                                    <th scope="col" class="px-6 py-3">IP Address</th>
                                    <th scope="col" class="px-6 py-3 hidden sm:table-cell">User ID</th>
                                    <th scope="col" class="px-6 py-3 text-center">Total Kemenangan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderboardRows.length > 0 ? leaderboardRows : '<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada pemenang tercatat.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // --- ADMIN VIEWS ---

            renderAdminProducts() {
                if (!this.isAdmin) return this.renderAccessDenied();
                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-2">Admin: Kelola Produk Dijual</h1>

                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Tambah/Edit Produk</h2>
                        <form id="product-form" onsubmit="App.handleProductSubmit(event)">
                            <input type="hidden" id="product-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-4">
                                    <input type="text" id="product-name" placeholder="Nama Produk" required class="w-full p-3 border border-gray-300 rounded-lg">
                                    <input type="number" id="product-price" placeholder="Harga (contoh: 50000)" required class="w-full p-3 border border-gray-300 rounded-lg">
                                    <input type="number" id="product-stock" placeholder="Stok Awal" required class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div class="space-y-4">
                                    <input type="text" id="product-category" placeholder="Kategori (contoh: Jaket)" required class="w-full p-3 border border-gray-300 rounded-lg">
                                    <input type="url" id="product-imageurl" placeholder="URL Gambar Produk (Contoh: https://...)" required class="w-full p-3 border border-gray-300 rounded-lg">
                                    <input type="url" id="product-buylink" placeholder="Link CTA Beli (Contoh: https://wa.me/...)" required class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end space-x-4">
                                <button type="button" onclick="App.clearProductForm()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition">Batal/Clear</button>
                                <button type="submit" id="product-submit-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">Tambah Produk</button>
                            </div>
                        </form>
                    </div>

                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Produk (${this.products.length})</h2>
                    <div class="overflow-x-auto shadow-md rounded-lg bg-white">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nama</th>
                                    <th scope="col" class="px-6 py-3">Kategori</th>
                                    <th scope="col" class="px-6 py-3">Harga</th>
                                    <th scope="col" class="px-6 py-3">Stok</th>
                                    <th scope="col" class="px-6 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="product-list-body">
                                <!-- Product rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                `;
            }

            renderProductList() {
                const listBody = document.getElementById('product-list-body');
                if (!listBody) return;

                listBody.innerHTML = this.products.map(product => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${product.name}</th>
                        <td class="px-6 py-4">${product.category}</td>
                        <td class="px-6 py-4">Rp ${this.formatRupiah(product.price)}</td>
                        <td class="px-6 py-4 font-bold ${product.stock < 10 ? 'text-red-500' : 'text-green-600'}">${product.stock}</td>
                        <td class="px-6 py-4 space-x-2">
                            <button onclick="App.editProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 font-medium">Edit</button>
                            <button onclick="App.deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900 font-medium">Hapus</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada produk.</td></tr>';
            }

            async handleProductSubmit(event) {
                event.preventDefault();
                if (!this.db || !this.isAdmin) return;

                const id = document.getElementById('product-id').value;
                const name = document.getElementById('product-name').value;
                const price = parseInt(document.getElementById('product-price').value);
                const stock = parseInt(document.getElementById('product-stock').value);
                const category = document.getElementById('product-category').value;
                const imageUrl = document.getElementById('product-imageurl').value;
                const buyLink = document.getElementById('product-buylink').value;

                const productData = { name, price, stock, category, imageUrl, buyLink };

                try {
                    if (id) {
                        // Edit existing product
                        const productRef = doc(this.getPublicCollectionRef(COLLECTIONS.PRODUCTS), id);
                        await updateDoc(productRef, productData);
                        console.log("Produk berhasil diupdate:", id);
                    } else {
                        // Add new product
                        await addDoc(this.getPublicCollectionRef(COLLECTIONS.PRODUCTS), productData);
                        console.log("Produk berhasil ditambahkan.");
                    }
                    this.clearProductForm();
                } catch (error) {
                    console.error("Gagal menyimpan produk:", error);
                }
            }

            editProduct(productId) {
                const product = this.products.find(p => p.id === productId);
                if (!product) return;

                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-imageurl').value = product.imageUrl;
                document.getElementById('product-buylink').value = product.buyLink;
                document.getElementById('product-submit-btn').textContent = 'Update Produk';
            }

            async deleteProduct(productId) {
                if (window.confirm("Yakin ingin menghapus produk ini?")) {
                    try {
                        const productRef = doc(this.getPublicCollectionRef(COLLECTIONS.PRODUCTS), productId);
                        await deleteDoc(productRef);
                        console.log("Produk berhasil dihapus:", productId);
                    } catch (error) {
                        console.error("Gagal menghapus produk:", error);
                    }
                }
            }

            clearProductForm() {
                document.getElementById('product-form').reset();
                document.getElementById('product-id').value = '';
                document.getElementById('product-submit-btn').textContent = 'Tambah Produk';
            }

            renderAdminMB() {
                if (!this.isAdmin) return this.renderAccessDenied();

                const totalPlays = this.mbPlays.length;
                const totalUsers = [...new Set(this.mbPlays.map(p => p.ipAddress))].length;
                const totalWins = this.mbPlays.filter(p => p.isWinner).length;

                return `
                    <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-2">Admin: Kelola Mystery Box Plays</h1>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold">Total Kali Main</h3>
                            <p class="text-4xl font-extrabold mt-2">${totalPlays}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-700">Total User (IP Unik)</h3>
                            <p class="text-4xl font-extrabold mt-2 text-indigo-600">${totalUsers}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-700">Total Kemenangan</h3>
                            <p class="text-4xl font-extrabold mt-2 text-green-600">${totalWins}</p>
                        </div>
                    </div>

                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Semua Permainan</h2>
                    <div class="overflow-x-auto shadow-md rounded-lg bg-white">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">IP Address (User)</th>
                                    <th scope="col" class="px-6 py-3">Bukti Bayar</th>
                                    <th scope="col" class="px-6 py-3">Konfirmasi Admin</th>
                                    <th scope="col" class="px-6 py-3">Status Menang</th>
                                    <th scope="col" class="px-6 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="mb-plays-body">
                                <!-- MB Play rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                `;
            }

            renderMBPlayList() {
                const listBody = document.getElementById('mb-plays-body');
                if (!listBody) return;

                // Group by IP and count plays per IP for display
                const ipPlayCounts = this.mbPlays.reduce((acc, play) => {
                    acc[play.ipAddress] = (acc[play.ipAddress] || 0) + 1;
                    return acc;
                }, {});

                // Sort by creation time (newest first)
                const sortedPlays = [...this.mbPlays].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                listBody.innerHTML = sortedPlays.map(play => {
                    const isApproved = play.isApproved;
                    const isWinner = play.isWinner;
                    const isPaid = play.isPaidProofSent;
                    const canOpen = isApproved && !play.hasOpened;
                    const playCount = ipPlayCounts[play.ipAddress];

                    let proofStatus, approvalStatus, winnerStatus;

                    if (isPaid) {
                        proofStatus = `<span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Terkirim</span>`;
                    } else {
                        proofStatus = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Menunggu</span>`;
                    }

                    if (isApproved) {
                        approvalStatus = `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Dikonfirmasi</span>`;
                    } else if (isPaid) {
                        approvalStatus = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Pending</span>`;
                    } else {
                        approvalStatus = `<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Belum Bayar</span>`;
                    }

                    if (play.hasOpened) {
                        winnerStatus = isWinner ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">MENANG (Klaim)</span>` : `<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Coba Lagi</span>`;
                    } else if (canOpen) {
                         winnerStatus = `<span class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Siap Dibuka</span>`;
                    } else {
                        winnerStatus = `<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded">Belum Dimainkan</span>`;
                    }


                    return `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                                <span class="font-bold">${play.ipAddress}</span>
                                <span class="text-xs text-gray-500 block">(${playCount}x Main)</span>
                                <span class="text-xs text-gray-500 block">ID: ${play.userId}</span>
                                <span class="text-xs text-gray-400 block">${new Date(play.timestamp).toLocaleString()}</span>
                            </th>
                            <td class="px-6 py-4">${proofStatus}</td>
                            <td class="px-6 py-4">${approvalStatus}</td>
                            <td class="px-6 py-4">${winnerStatus}</td>
                            <td class="px-6 py-4 space-y-2 flex flex-col items-start">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" ${isApproved ? 'checked' : ''} onchange="App.toggleMBApproval('${play.id}', this.checked)">
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    <span class="ms-3 text-sm font-medium text-gray-900">Konfirm Bayar</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" ${isWinner ? 'checked' : ''} onchange="App.toggleMBWinner('${play.id}', this.checked)" ${!isApproved ? 'disabled' : ''}>
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    <span class="ms-3 text-sm font-medium text-gray-900">Menang</span>
                                </label>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada data permainan Mystery Box.</td></tr>';
            }

            async toggleMBApproval(playId, isApproved) {
                if (!this.db || !this.isAdmin) return;
                try {
                    const playRef = doc(this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS), playId);
                    await updateDoc(playRef, { isApproved: isApproved });
                    console.log(`Mystery Box Play ${playId} Approval set to: ${isApproved}`);
                } catch (error) {
                    console.error("Gagal update approval:", error);
                }
            }

            async toggleMBWinner(playId, isWinner) {
                if (!this.db || !this.isAdmin) return;

                // Ensure the play is approved before setting winner status
                const play = this.mbPlays.find(p => p.id === playId);
                if (!play || !play.isApproved) {
                    alert('Tidak bisa menentukan pemenang sebelum pembayaran dikonfirmasi!');
                    return;
                }

                try {
                    const playRef = doc(this.getPublicCollectionRef(COLLECTIONS.MB_PLAYS), playId);
                    await updateDoc(playRef, { isWinner: isWinner });
                    console.log(`Mystery Box Play ${playId} Winner status set to: ${isWinner}`);
                } catch (error) {
                    console.error("Gagal update winner status:", error);
                }
            }


            renderAccessDenied() {
                return `
                    <div class="text-center p-10 bg-red-100 border border-red-400 text-red-800 rounded-xl shadow-lg mt-10">
                        <i data-lucide="lock" class="w-10 h-10 mx-auto mb-4"></i>
                        <h1 class="text-2xl font-bold">Akses Ditolak</h1>
                        <p class="mt-2">Anda tidak memiliki izin Admin untuk melihat halaman ini.</p>
                        <button onclick="App.toggleAdminView()" class="mt-4 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">Kembali ke User View</button>
                    </div>
                `;
            }

            // --- Utility Functions ---
            formatRupiah(number) {
                return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if App is already initialized (e.g., in a development environment)
            if (typeof window.App === 'undefined') {
                window.App = new StoreApp();

                // Attach event listeners for hamburger menu
                document.getElementById('hamburger-btn').addEventListener('click', () => {
                    window.App.toggleSidebar();
                });

                // Attach event listeners for mobile admin switch
                document.getElementById('admin-switch-btn').addEventListener('click', () => {
                    window.App.toggleAdminView();
                });
            }
        });

    </script>
</body>
</html>