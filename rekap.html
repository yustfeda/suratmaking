<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penilaian PBB Multi Juri</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter secara default */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Style untuk Sidebar di Mobile */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        .sidebar.open {
            transform: translateX(0);
        }
        /* Style untuk PDF Printing */
        @media print {
            /* Sembunyikan semua elemen non-cetak */
            body * { visibility: hidden !important; }
            /* Tampilkan hanya konten rekap */
            #pdf-recap-content, #pdf-recap-content * { visibility: visible !important; }
            #pdf-recap-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
                background: white;
            }
            .no-print { display: none !important; }
            /* Memastikan tabel terlihat rapih saat dicetak */
            #pdf-recap-content table { border-collapse: collapse; width: 100%; margin: 10px 0; }
            #pdf-recap-content th, #pdf-recap-content td { border: 1px solid #000; padding: 6px; font-size: 10px; text-align: center; }
            #pdf-recap-content .text-left { text-align: left; }
            #pdf-recap-content h3 { font-size: 16px; margin-bottom: 8px; }
            #pdf-recap-content .header-total { font-size: 18px; font-weight: bold; }
        }
        /* Custom PBB table style */
        .pbb-table th, .pbb-table td {
            padding: 8px 4px;
        }
        .pbb-table th:nth-child(2), .pbb-table td:nth-child(2) {
             text-align: left;
        }
        .pbb-table .score-cell {
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- HEADER / NAVIGATION BAR -->
        <header class="bg-indigo-600 shadow-md p-4 flex items-center justify-between no-print">
            <div class="flex items-center">
                <!-- Hamburger Menu for Mobile -->
                <button id="menu-toggle" class="lg:hidden text-white mr-4 p-2 rounded-md hover:bg-indigo-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl font-bold text-white">Aplikasi Penilaian PBB</h1>
            </div>
            <div id="nav-desktop" class="hidden lg:flex items-center space-x-4">
                <!-- Menu Desktop (Sama dengan Sidebar) -->
            </div>
            <div id="user-info" class="text-white text-sm"></div>
        </header>

        <!-- MAIN LAYOUT (Sidebar + Content) -->
        <div class="flex flex-1 relative">
            
            <!-- SIDEBAR (Mobile & Desktop) -->
            <nav id="sidebar" class="sidebar fixed inset-y-0 left-0 z-30 w-64 bg-white shadow-xl lg:relative lg:translate-x-0 lg:shadow-none no-print">
                <div class="p-4 space-y-2">
                    <!-- Nav Items will be inserted here -->
                </div>
            </nav>

            <!-- MAIN CONTENT AREA -->
            <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                <div id="loading" class="text-center p-10 hidden">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 inline-block"></div>
                    <p class="mt-4 text-gray-600">Memuat data...</p>
                </div>
                <!-- Content will be rendered here (Login, Scorer, Admin) -->
            </main>
        </div>

        <!-- MODAL PLACEHOLDER -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden justify-center items-center no-print">
            <!-- Modal content will be injected here -->
        </div>

    </div>

    <!-- APP LOGIC (USING localStorage) -->
    <script>
        // ====================================================================
        // 1. CONFIGURATION & LOCAL STORAGE UTILITIES
        // ====================================================================

        const ADMIN_PASSWORD = 'Piring123';
        const SCORER_PASSWORD = 'Danukasep';
        
        // Kunci Local Storage
        const LS_KEYS = {
            TEAMS: 'pbb_teams',
            SCORES: 'pbb_scores',
            CONFIG: 'pbb_config',
            CRITERIA: 'pbb_criteria_v2', 
            JUDGES: 'pbb_judges', 
            USER_ROLE: 'session_user_role',
            USER_NAME: 'session_user_name',
            CURRENT_JUDGE_ID: 'session_current_judge_id', 
        };

        // Nilai Diskrit Default
        const DEFAULT_CRITERIA_VALUES = {
            CUKUP: [40, 45, 50],
            BAIK: [60, 65, 70],
            BAIK_SEKALI: [75, 78, 80]
        };
        
        // Kategori Penilaian
        const SCORE_CATEGORIES = {
            CUKUP: 'Cukup',
            BAIK: 'Baik',
            BAIK_SEKALI: 'Baik Sekali'
        };

        // Default Juri (Untuk inisialisasi awal)
        const DEFAULT_JUDGES = [
            { id: 'judge-001', name: 'Juri 1' },
            { id: 'judge-002', name: 'Juri 2' }
        ];

        // Default PBB Criteria 
        const DEFAULT_PBB_CRITERIA = [
            // Gerakan Di Tempat
            { id: 'sikap_sempurna', name: 'Sikap Sempurna', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'hormat', name: 'Hormat', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'istirahat', name: 'Istirahat di Tempat', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'hadap_kanan', name: 'Hadap Kanan', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'hadap_kiri', name: 'Hadap Kiri', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'balik_kanan_1', name: 'Balik Kanan', category: 'Gerakan Di Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            // Gerakan Berpindah Tempat
            { id: 'langkah_biasa', name: 'Langkah Biasa', category: 'Gerakan Berpindah Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'langkah_tegap', name: 'Langkah Tegap', category: 'Gerakan Berpindah Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'henti_langkah', name: 'Henti dari Langkah', category: 'Gerakan Berpindah Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'periksa_kerapian', name: 'Periksa Kerapian', category: 'Gerakan Berpindah Tempat', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            // Gerakan Gabungan/Lainnya
            { id: 'buka_barisan', name: 'Buka/Tutup Barisan', category: 'Gerakan Gabungan', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'tinggalkan_barisan', name: 'Meninggalkan Barisan', category: 'Gerakan Gabungan', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'ketua_komandan', name: 'Kualitas Komandan', category: 'Ketua Komandan', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
            { id: 'kerapihan_seragam', name: 'Kerapihan Seragam', category: 'Kerapihan dan Atribut', values: {...DEFAULT_CRITERIA_VALUES}, initialScore: 40 },
        ];
        
        // State global
        let participants = [];
        let scores = [];
        let pbbCriteria = []; 
        let judges = []; 
        let editToken = null;
        let currentView = 'login';
        let currentTeamId = null;
        let loadingState = false;
        
        let userRole = localStorage.getItem(LS_KEYS.USER_ROLE) || null;
        let userName = localStorage.getItem(LS_KEYS.USER_NAME) || null; // Nama tampilan di header
        let currentJudgeId = localStorage.getItem(LS_KEYS.CURRENT_JUDGE_ID) || null; // ID Juri yang sedang dipilih
        
        /**
         * Mengambil data dari localStorage.
         */
        function loadData(key) {
            const data = localStorage.getItem(key);
            try {
                if (!data) {
                    if (key === LS_KEYS.CRITERIA) return DEFAULT_PBB_CRITERIA;
                    if (key === LS_KEYS.JUDGES) return DEFAULT_JUDGES;
                    if (key === LS_KEYS.CONFIG) return {};
                    return [];
                }
                return JSON.parse(data);
            } catch (e) {
                console.error(`Error parsing data for key ${key}:`, e);
                return (key === LS_KEYS.CONFIG ? {} : (key === LS_KEYS.CRITERIA ? DEFAULT_PBB_CRITERIA : (key === LS_KEYS.JUDGES ? DEFAULT_JUDGES : [])));
            }
        }

        /**
         * Menyimpan data ke localStorage.
         */
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        /**
         * Simulasikan "onSnapshot" dengan memuat data dan merender ulang.
         */
        function refreshDataAndRender() {
            setLoading(true);

            participants = loadData(LS_KEYS.TEAMS);
            scores = loadData(LS_KEYS.SCORES);
            pbbCriteria = loadData(LS_KEYS.CRITERIA); 
            judges = loadData(LS_KEYS.JUDGES); 
            const config = loadData(LS_KEYS.CONFIG);
            editToken = config.editToken || null;
            
            userRole = localStorage.getItem(LS_KEYS.USER_ROLE);
            userName = localStorage.getItem(LS_KEYS.USER_NAME);
            currentJudgeId = localStorage.getItem(LS_KEYS.CURRENT_JUDGE_ID);

            // Atur tim yang sedang dilihat
            if (!currentTeamId && participants.length > 0) {
                currentTeamId = participants[0].id;
            } else if (participants.length > 0 && !participants.some(p => p.id === currentTeamId)) {
                 currentTeamId = participants[0].id;
            } else if (participants.length === 0) {
                currentTeamId = null;
            }

            // Pastikan Juri yang dipilih saat ini masih ada di daftar Juri
            if (currentJudgeId && !judges.some(j => j.id === currentJudgeId)) {
                currentJudgeId = null;
                localStorage.removeItem(LS_KEYS.CURRENT_JUDGE_ID);
                if (userRole === 'scorer') {
                     // Jika peran Juri hilang, Juri harus memilih peran lagi
                    currentView = 'scorer_selection'; 
                }
            }
            
            // Set default view untuk scorer jika belum memilih peran
            if (userRole === 'scorer' && !currentJudgeId) {
                currentView = 'scorer_selection';
            } else if (userRole === 'scorer' && currentView === 'scorer_selection') {
                 // Jika sudah memilih, kembali ke dashboard
                currentView = 'scorer';
            }


            // Cek inisialisasi awal (jika tidak ada data Juri, simpan default)
            if (judges.length === 0) {
                judges = DEFAULT_JUDGES;
                saveData(LS_KEYS.JUDGES, judges);
            }
            
            // Panggil render setelah semua data dimuat
            renderApp();
            setLoading(false);
        }

        // ====================================================================
        // 2. UI RENDERING & ROUTING
        // ====================================================================

        function setLoading(isLoading) {
            const loadingEl = document.getElementById('loading');
            const mainContentEl = document.getElementById('main-content');
            
            if (loadingEl && mainContentEl) {
                loadingEl.classList.toggle('hidden', !isLoading);
                mainContentEl.classList.toggle('opacity-50', isLoading);
            }
            loadingState = isLoading;
        }

        function renderLogin() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="max-w-md mx-auto mt-16 p-8 bg-white shadow-xl rounded-xl">
                    <h2 class="text-3xl font-bold text-center text-indigo-600 mb-6">Login Aplikasi Penilaian</h2>
                    <form id="login-form">
                        <div class="mb-6">
                            <label for="password" class="block text-gray-700 font-medium mb-2">Password Akses</label>
                            <input type="password" id="password" placeholder="Masukkan Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <p class="text-sm text-gray-500 mt-2">Gunakan: 'Piring123' untuk Admin, atau 'Danukasep' untuk Juri.</p>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">LOGIN</button>
                    </form>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function renderApp() {
            setLoading(false);
            if (!userRole) return renderLogin();

            renderHeader();
            renderSidebar();
            
            if (userRole === 'admin') {
                if (currentView === 'admin') renderAdminDashboard();
                else if (currentView === 'judge') renderJudgeManagement(); 
                else if (currentView === 'recap') renderRecapDashboard();
                else if (currentView === 'token') renderTokenManagement();
                else if (currentView === 'criteria') renderCriteriaManagement();
                else renderAdminDashboard(); 
            } else { // Scorer/User
                if (currentView === 'scorer_selection') renderJudgeSelection();
                else if (currentView === 'scorer') renderScorerDashboard();
                else renderJudgeSelection(); // Fallback jika belum memilih peran
            }
        }

        function renderHeader() {
            const currentJudge = judges.find(j => j.id === currentJudgeId);
            const judgeDisplay = userRole === 'scorer' && currentJudge ? ` (${currentJudge.name})` : '';
            const userDisplay = userName || (userRole === 'admin' ? 'Admin' : 'Juri Penilai');

            document.getElementById('user-info').innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="font-medium">${userDisplay}${judgeDisplay}</span>
                    <button id="logout-btn" class="text-xs bg-indigo-500 hover:bg-indigo-400 py-1 px-3 rounded-full transition duration-150">Keluar</button>
                </div>
            `;
            document.getElementById('logout-btn').onclick = handleLogout;
        }

        function renderSidebar() {
            const isMobile = window.innerWidth < 1024;
            const menuItems = userRole === 'admin' ? [
                { id: 'admin', label: 'Peserta' },
                { id: 'judge', label: 'Kelola Juri' }, 
                { id: 'criteria', label: 'Kelola Kriteria' },
                { id: 'recap', label: 'Rekap Nilai' },
                { id: 'token', label: 'Token Edit' },
            ] : [
                { id: 'scorer', label: 'Penilaian' },
                // Tambahkan opsi untuk pindah peran Juri
                { id: 'scorer_selection', label: 'Pilih Peran Juri' },
            ];

            const navDesktop = document.getElementById('nav-desktop');
            const sidebar = document.getElementById('sidebar');
            const navContainer = isMobile ? sidebar.querySelector('div') : navDesktop;
            
            // Clear existing menu items
            while (navContainer.firstChild) {
                navContainer.removeChild(navContainer.firstChild);
            }

            menuItems.forEach(item => {
                // Jangan tampilkan menu lain jika Juri belum memilih peran di awal
                if (userRole === 'scorer' && !currentJudgeId && item.id !== 'scorer_selection') return;
                
                const isActive = currentView === item.id || (currentView === 'scorer_selection' && item.id === 'scorer_selection');
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-3 rounded-lg font-medium transition duration-150 ${
                    isActive ? 'bg-indigo-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-100'
                } ${isMobile ? '' : 'lg:w-auto lg:px-4 lg:py-2 lg:bg-transparent lg:hover:bg-indigo-700 lg:text-white lg:hover:text-white'}`;
                btn.textContent = item.label;
                btn.onclick = () => {
                    currentView = item.id;
                    if (isMobile) sidebar.classList.remove('open');
                    refreshDataAndRender(); 
                };
                navContainer.appendChild(btn);
            });

            document.getElementById('menu-toggle').onclick = () => sidebar.classList.toggle('open');
            // Menutup sidebar ketika klik di luar pada mode mobile
            sidebar.onclick = (e) => {
                if (e.target.id === 'sidebar' && isMobile) sidebar.classList.remove('open');
            };
        }

        // ====================================================================
        // 3. SCORER DASHBOARD (JURI)
        // ====================================================================

        function renderScorerDashboard() {
            const mainContent = document.getElementById('main-content');
            
            // Cek apakah Juri sudah memilih peran Juri mereka (Juri 1, Juri 2, dst)
            if (!currentJudgeId || !judges.some(j => j.id === currentJudgeId)) {
                return renderJudgeSelection();
            }

            const currentJudge = judges.find(j => j.id === currentJudgeId);
            const currentJudgeName = currentJudge ? currentJudge.name : 'Juri Tidak Dikenal';

            // Cari skor saat ini oleh Juri ini untuk tim yang dipilih
            const currentScore = scores.find(s => s.teamId === currentTeamId && s.judgeId === currentJudgeId);
            const isLocked = currentScore && currentScore.isLocked;
            const sessionToken = sessionStorage.getItem('current_edit_token');
            const isUnlocked = isLocked && sessionToken === editToken && editToken !== null;
            const isDisabled = isLocked && !isUnlocked;
            
            const teamOptions = participants.map(p => 
                `<option value="${p.id}" ${p.id === currentTeamId ? 'selected' : ''}>${p.name}</option>`
            ).join('');

            const judgeOptions = judges.map(j => 
                `<option value="${j.id}" ${j.id === currentJudgeId ? 'selected' : ''}>${j.name}</option>`
            ).join('');

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6 flex-wrap">
                    <h2 class="text-3xl font-semibold text-gray-800">Penilaian PBB</h2>
                    <div class="flex space-x-2 mt-4 md:mt-0">
                        <select id="team-select" class="p-2 border border-gray-300 rounded-lg shadow-sm font-medium w-40">
                            ${participants.length === 0 ? '<option value="">-- Tidak Ada Peserta --</option>' : teamOptions}
                        </select>
                        <!-- Judge switch is only for display, actual switch is in sidebar/selection -->
                        <div class="flex items-center p-2 border border-gray-300 rounded-lg shadow-sm font-medium w-36 bg-gray-50">
                            ${currentJudgeName}
                        </div>
                    </div>
                </div>

                ${participants.length === 0 ? '<p class="text-center text-gray-500 p-10 bg-white rounded-xl shadow">Belum ada peserta yang ditambahkan. Silakan hubungi Admin.</p>' : ''}
                
                <div id="scoring-area" class="${participants.length === 0 ? 'hidden' : ''}">
                    <div class="bg-indigo-50 p-4 mb-4 rounded-lg flex justify-between items-center flex-wrap">
                        <p class="font-bold text-indigo-800">Anda menilai sebagai: 
                            <span id="current-judge-name-display">${currentJudgeName}</span>
                        </p>
                        <button onclick="currentView = 'scorer_selection'; refreshDataAndRender();" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition duration-150 p-1">
                             <svg class="w-4 h-4 inline-block -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            Ganti Peran Juri
                        </button>
                    </div>

                    ${isLocked ? `
                        <div class="p-4 mb-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
                            <p class="font-bold">Nilai Dikunci oleh ${currentJudgeName}!</p>
                            ${isUnlocked ? '' : `<p>Untuk mengubah nilai, masukkan Token Izin Edit dari Admin di bawah ini.</p>`}
                        </div>
                        <div class="flex space-x-2 mb-4 ${isUnlocked ? 'hidden' : ''}">
                            <input type="text" id="edit-token-input" placeholder="Masukkan Token Edit" class="p-2 border border-gray-300 rounded-lg w-full max-w-sm" value="${sessionToken || ''}" />
                            <button id="check-token-btn" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition">Cek Token</button>
                        </div>
                        ${isUnlocked ? '<p class="text-green-600 font-medium mb-4">Token valid! Anda dapat mengedit nilai.</p>' : ''}
                    ` : ''}

                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <form id="scoring-form">
                            <table class="min-w-full divide-y divide-gray-200 pbb-table">
                                <thead class="bg-indigo-50">
                                    <tr>
                                        <th rowspan="2" class="w-10">NO</th>
                                        <th rowspan="2" class="text-left w-1/4">KRITERIA PENILAIAN</th>
                                        <th colspan="3" class="border-b border-gray-200">NILAI AKHIR</th>
                                    </tr>
                                    <tr class="text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        <th class="py-2 px-0 w-1/4 text-center">CUKUP</th>
                                        <th class="py-2 px-0 w-1/4 text-center">BAIK</th>
                                        <th class="py-2 px-0 w-1/4 text-center">BAIK SEKALI</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="criteria-rows">
                                    ${currentTeamId ? renderCriteriaRows(currentScore, isDisabled) : '<tr><td colspan="5" class="text-center py-4 text-gray-500">Pilih peserta untuk memulai.</td></tr>'}
                                </tbody>
                                <tfoot>
                                    <tr class="bg-gray-100 font-bold">
                                        <td colspan="2" class="px-3 py-3 text-right">JUMLAH:</td>
                                        <td colspan="3" id="total-score" class="px-3 py-3 text-center text-lg text-indigo-700">0</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div class="flex justify-end mt-6">
                                <button type="submit" id="save-btn" class="bg-green-600 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-150 disabled:opacity-50" ${isDisabled ? 'disabled' : ''}>
                                    ${isLocked ? 'SIMPAN PERUBAHAN & KUNCI ULANG' : 'SIMPAN NILAI & KUNCI'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Attach event listeners
            if (currentTeamId) {
                document.getElementById('team-select').addEventListener('change', (e) => {
                    currentTeamId = e.target.value;
                    refreshDataAndRender();
                });
                document.getElementById('scoring-form').addEventListener('change', updateScorerTotal);
                document.getElementById('scoring-form').addEventListener('submit', handleSaveScore);
                updateScorerTotal(); 
            }
            
            if (isLocked && !isUnlocked) {
                document.getElementById('check-token-btn').addEventListener('click', handleCheckToken);
            }
        }

        function renderCriteriaRows(currentScore, isDisabled) {
            let html = '';
            let currentCategory = '';
            
            pbbCriteria.forEach((criteria, index) => {
                // Tampilkan kategori baru jika berubah
                if (criteria.category !== currentCategory) {
                    html += `
                        <tr class="bg-indigo-100">
                            <td colspan="5" class="px-3 py-2 text-left font-bold text-indigo-700">${criteria.category}</td>
                        </tr>
                    `;
                    currentCategory = criteria.category;
                }

                // Tentukan nilai yang sudah dipilih
                const savedScore = currentScore && currentScore.scores[criteria.id] ? currentScore.scores[criteria.id].score : criteria.initialScore;
                
                // Fungsi untuk membuat radio button
                const createRadio = (categoryKey) => {
                    // Cari nilai tengah dari 3 pilihan nilai
                    const scoreValue = criteria.values[categoryKey][1]; 
                    const isChecked = savedScore === scoreValue;
                    
                    return `
                        <label class="flex items-center justify-center h-full w-full cursor-pointer transition duration-100">
                            <input 
                                type="radio" 
                                name="score_${criteria.id}" 
                                value="${scoreValue}" 
                                data-category="${categoryKey}"
                                class="hidden" 
                                ${isChecked ? 'checked' : ''} 
                                ${isDisabled ? 'disabled' : ''}
                            >
                            <span class="w-full text-center py-2 px-1 text-sm font-medium ${isChecked ? 'bg-green-100 text-green-700 border-2 border-green-500 rounded-lg shadow-inner' : 'text-gray-600 hover:bg-gray-100 rounded-lg'}">
                                ${scoreValue}
                            </span>
                        </label>
                    `;
                };

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="text-left font-medium text-gray-700">${criteria.name}</td>
                        <td class="score-cell">${createRadio('CUKUP')}</td>
                        <td class="score-cell">${createRadio('BAIK')}</td>
                        <td class="score-cell">${createRadio('BAIK_SEKALI')}</td>
                    </tr>
                `;
            });
            return html;
        }

        function updateScorerTotal() {
            const form = document.getElementById('scoring-form');
            if (!form) return;
            let totalScore = 0;
            pbbCriteria.forEach(criteria => {
                const checkedRadio = form.querySelector(`input[name="score_${criteria.id}"]:checked`);
                if (checkedRadio) {
                    totalScore += parseInt(checkedRadio.value);
                }
            });
            document.getElementById('total-score').textContent = totalScore;
        }

        function renderJudgeSelection() {
             const mainContent = document.getElementById('main-content');
             const judgeOptions = judges.map(j => 
                `<option value="${j.id}">${j.name}</option>`
            ).join('');

             mainContent.innerHTML = `
                <div class="max-w-md mx-auto mt-10 p-8 bg-white shadow-lg rounded-xl">
                    <h2 class="text-3xl font-bold text-center text-indigo-600 mb-6">Pilih Peran Juri Anda</h2>
                    <p class="text-center text-gray-600 mb-4">Pilih nama Juri yang akan Anda gunakan untuk mencatat nilai. Anda akan menilai sebagai peran ini.</p>
                    <div class="mb-6">
                        <label for="judge-select-initial" class="block text-gray-700 font-medium mb-2">Pilih Juri</label>
                        <select id="judge-select-initial" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Pilih salah satu --</option>
                            ${judgeOptions}
                        </select>
                    </div>
                    <button id="start-scoring-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150" disabled>Mulai Menilai</button>
                </div>
            `;
            const selectEl = document.getElementById('judge-select-initial');
            const startBtn = document.getElementById('start-scoring-btn');

            selectEl.addEventListener('change', () => {
                startBtn.disabled = !selectEl.value;
            });

            startBtn.addEventListener('click', () => {
                handleJudgeRoleSwitch(selectEl.value);
            });
        }
        
        function handleJudgeRoleSwitch(judgeId) {
            const judge = judges.find(j => j.id === judgeId);
            if (!judge) {
                showMessage("Error", "Juri tidak ditemukan.", 'error');
                return;
            }
            
            currentJudgeId = judgeId;
            // Set userName di sesi menjadi nama Juri yang dipilih
            userName = judge.name; 
            
            localStorage.setItem(LS_KEYS.CURRENT_JUDGE_ID, judgeId);
            localStorage.setItem(LS_KEYS.USER_NAME, judge.name);

            // Setelah memilih, pindah ke dashboard penilaian
            currentView = 'scorer';
            refreshDataAndRender();
        }
        
        function handleSaveScore(event) {
            event.preventDefault();
            setLoading(true);

            const team = participants.find(p => p.id === currentTeamId);
            const judge = judges.find(j => j.id === currentJudgeId);

            if (!team || !judge) {
                setLoading(false);
                return console.error("Team or Judge not found.");
            }

            const form = document.getElementById('scoring-form');
            let scoresData = {};
            let totalScore = 0;
            let allValid = true;

            pbbCriteria.forEach(criteria => {
                const checkedRadio = form.querySelector(`input[name="score_${criteria.id}"]:checked`);
                
                if (checkedRadio) {
                    const scoreVal = parseInt(checkedRadio.value);
                    const categoryKey = checkedRadio.dataset.category;
                    
                    scoresData[criteria.id] = {
                        score: scoreVal,
                        categoryKey: categoryKey,
                        categoryName: SCORE_CATEGORIES[categoryKey]
                    };
                    totalScore += scoreVal;
                } else {
                    allValid = false;
                }
            });

            if (!allValid) {
                showMessage("Lengkapi Penilaian", "Harap pastikan semua kriteria sudah diberi nilai.", 'warning');
                setLoading(false);
                return;
            }

            // Cari index skor yang sudah ada oleh Juri ini untuk tim ini
            const existingScoreIndex = scores.findIndex(s => s.teamId === currentTeamId && s.judgeId === currentJudgeId);
            const scoreId = existingScoreIndex !== -1 ? scores[existingScoreIndex].id : crypto.randomUUID();

            const scoreData = {
                id: scoreId,
                teamId: currentTeamId,
                teamName: team.name,
                judgeId: currentJudgeId, 
                judgeName: judge.name, 
                isLocked: true, // Selalu dikunci setelah disimpan
                scores: scoresData,
                totalScore: totalScore,
                timestamp: Date.now()
            };

            try {
                if (existingScoreIndex !== -1) {
                    scores[existingScoreIndex] = scoreData;
                    showMessage("Berhasil", `Nilai oleh ${judge.name} berhasil diperbarui dan dikunci!`, 'success');
                } else {
                    scores.push(scoreData);
                    showMessage("Berhasil", `Nilai oleh ${judge.name} berhasil disimpan dan dikunci!`, 'success');
                }
                saveData(LS_KEYS.SCORES, scores);
                sessionStorage.removeItem('current_edit_token'); 
            } catch (error) {
                console.error("Error saving score:", error);
                showMessage("Gagal", `Gagal menyimpan nilai: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                refreshDataAndRender();
            }
        }
        
        function handleCheckToken() {
            setLoading(true);
            const inputToken = document.getElementById('edit-token-input').value.trim().toUpperCase();
            
            if (inputToken === editToken && editToken !== null) {
                sessionStorage.setItem('current_edit_token', inputToken);
                showMessage("Token Valid", "Token diterima. Anda sekarang dapat mengedit nilai ini.", 'success');
            } else {
                showMessage("Token Salah", "Token yang dimasukkan tidak valid. Mohon periksa kembali.", 'error');
                sessionStorage.removeItem('current_edit_token');
            }
            setLoading(false);
            refreshDataAndRender();
        }

        // ====================================================================
        // 4. ADMIN DASHBOARD - Peserta & Juri
        // ====================================================================
        
        // --- Administrasi Peserta (Unchanged) ---
        function renderAdminDashboard() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Administrasi Peserta</h2>
                
                <!-- Form Tambah Peserta -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">Tambah Peserta Baru</h3>
                    <form id="add-participant-form" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <input type="text" id="new-participant-name" placeholder="Nama Peserta (mis. Regu A)" class="p-3 border border-gray-300 rounded-lg flex-1" required>
                        <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Tambah Peserta</button>
                    </form>
                </div>

                <!-- Daftar Peserta -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Daftar Peserta (${participants.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Peserta</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="participant-list">
                                ${participants.map(p => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.id.substring(0, 8)}...</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <button data-id="${p.id}" class="delete-participant-btn text-red-600 hover:text-red-900 font-medium transition duration-150">Hapus</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${participants.length === 0 ? '<p class="text-center text-gray-500 py-4">Belum ada peserta.</p>' : ''}
                </div>
            `;
            document.getElementById('add-participant-form').addEventListener('submit', handleAddParticipant);
            document.querySelectorAll('.delete-participant-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteParticipant(e.target.dataset.id));
            });
        }
        
        function handleAddParticipant(event) {
            event.preventDefault();
            setLoading(true);
            const nameInput = document.getElementById('new-participant-name');
            const newName = nameInput.value.trim();
            const newId = crypto.randomUUID();

            if (newName) {
                try {
                    const newParticipant = { id: newId, name: newName };
                    participants.push(newParticipant);
                    saveData(LS_KEYS.TEAMS, participants);
                    nameInput.value = '';
                    showMessage("Sukses", `Peserta '${newName}' berhasil ditambahkan.`, 'success');
                } catch (error) {
                    console.error("Error adding participant:", error);
                    showMessage("Gagal", `Gagal menambahkan peserta: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                    refreshDataAndRender();
                }
            }
        }

        async function handleDeleteParticipant(id) {
            const teamName = participants.find(p => p.id === id)?.name || id;
            if (!await showConfirmation("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus peserta '${teamName}'? Semua nilai untuk peserta ini akan terhapus!`)) return;

            setLoading(true);
            try {
                participants = participants.filter(p => p.id !== id);
                saveData(LS_KEYS.TEAMS, participants);
                scores = scores.filter(s => s.teamId !== id);
                saveData(LS_KEYS.SCORES, scores);
                
                showMessage("Sukses", `Peserta '${teamName}' dan semua nilainya berhasil dihapus.`, 'success');
            } catch (error) {
                console.error("Error deleting participant:", error);
                showMessage("Gagal", `Gagal menghapus peserta: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                refreshDataAndRender();
            }
        }

        // --- Administrasi Juri ---
        function renderJudgeManagement() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Administrasi Juri</h2>
                
                <!-- Form Tambah Juri -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">Tambah/Edit Juri</h3>
                    <form id="add-judge-form" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <input type="text" id="new-judge-name" placeholder="Nama Juri (mis. Juri 3)" class="p-3 border border-gray-300 rounded-lg flex-1" required>
                        <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Tambah Juri</button>
                    </form>
                </div>

                <!-- Daftar Juri -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Daftar Juri Aktif (${judges.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID Juri (Singkat)</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Juri</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="judge-list">
                                ${judges.map(j => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${j.id.substring(0, 8)}...</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${j.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <button data-id="${j.id}" class="edit-judge-name-admin-btn text-blue-600 hover:text-blue-900 font-medium transition duration-150 mr-3">Edit</button>
                                            <button data-id="${j.id}" class="delete-judge-btn text-red-600 hover:text-red-900 font-medium transition duration-150">Hapus</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${judges.length === 0 ? '<p class="text-center text-gray-500 py-4">Belum ada Juri.</p>' : ''}
                    <p class="text-sm text-red-500 mt-4">PERINGATAN: Menghapus Juri akan menghapus semua nilai yang telah dicatat oleh Juri tersebut!</p>
                </div>
            `;

            document.getElementById('add-judge-form').addEventListener('submit', handleAddJudge);
            document.querySelectorAll('.delete-judge-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteJudge(e.target.dataset.id));
            });
            document.querySelectorAll('.edit-judge-name-admin-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleEditJudgeNameAdmin(e.target.dataset.id));
            });
        }

        function handleAddJudge(event) {
            event.preventDefault();
            setLoading(true);
            const nameInput = document.getElementById('new-judge-name');
            const newName = nameInput.value.trim();
            // Gunakan ID yang unik agar berbeda dari default judges
            const newId = `judge-${crypto.randomUUID().substring(0, 8)}`; 

            if (newName) {
                try {
                    const newJudge = { id: newId, name: newName };
                    judges.push(newJudge);
                    saveData(LS_KEYS.JUDGES, judges);
                    nameInput.value = '';
                    showMessage("Sukses", `Juri '${newName}' berhasil ditambahkan. ID: ${newId.substring(0, 8)}...`, 'success');
                } catch (error) {
                    console.error("Error adding judge:", error);
                    showMessage("Gagal", `Gagal menambahkan Juri: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                    refreshDataAndRender();
                }
            }
        }

        async function handleDeleteJudge(id) {
            const judgeName = judges.find(j => j.id === id)?.name || id;
            if (!await showConfirmation("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus Juri '${judgeName}'? Semua nilai yang dicatat oleh Juri ini akan terhapus!`)) return;

            setLoading(true);
            try {
                judges = judges.filter(j => j.id !== id);
                saveData(LS_KEYS.JUDGES, judges);
                scores = scores.filter(s => s.judgeId !== id);
                saveData(LS_KEYS.SCORES, scores);
                
                // Reset sesi jika Juri yang sedang login dihapus
                if (currentJudgeId === id) {
                    currentJudgeId = null;
                    userName = null;
                    localStorage.removeItem(LS_KEYS.CURRENT_JUDGE_ID);
                    localStorage.removeItem(LS_KEYS.USER_NAME);
                }
                
                showMessage("Sukses", `Juri '${judgeName}' dan semua nilainya berhasil dihapus.`, 'success');
            } catch (error) {
                console.error("Error deleting judge:", error);
                showMessage("Gagal", `Gagal menghapus Juri: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                refreshDataAndRender();
            }
        }

        async function handleEditJudgeNameAdmin(id) {
            const judge = judges.find(j => j.id === id);
            if (!judge) return showMessage("Error", "Juri tidak ditemukan.", 'error');

            const newName = await showPrompt("Edit Nama Juri", `Masukkan nama baru untuk ${judge.name}:`, judge.name);

            if (newName && newName.trim()) {
                const index = judges.findIndex(j => j.id === id);
                if (index !== -1) {
                    const trimmedName = newName.trim();
                    // Update nama di daftar Juri
                    judges[index].name = trimmedName;
                    saveData(LS_KEYS.JUDGES, judges);
                    
                    // Update nama Juri di semua skor yang sudah ada
                    scores.forEach(s => {
                        if (s.judgeId === id) {
                            s.judgeName = trimmedName;
                        }
                    });
                    saveData(LS_KEYS.SCORES, scores);

                    // Update nama di sesi jika Juri yang sedang dipilih yang diedit
                    if (currentJudgeId === id) {
                         userName = trimmedName;
                         localStorage.setItem(LS_KEYS.USER_NAME, trimmedName);
                    }

                    showMessage("Sukses", `Nama Juri berhasil diubah menjadi ${trimmedName}.`, 'success');
                    refreshDataAndRender();
                }
            } else if (newName !== null) {
                showMessage("Gagal", "Nama Juri tidak boleh kosong.", 'error');
            }
        }

        // --- Token Management (Unchanged) ---
        function renderTokenManagement() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Manajemen Token Edit Nilai</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 max-w-lg mx-auto">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">Token Saat Ini</h3>
                    <div class="flex items-center space-x-4 mb-4">
                        <input type="text" id="current-token" class="p-3 border border-gray-300 rounded-lg flex-1 text-lg font-mono bg-gray-50" value="${editToken || 'TIDAK ADA TOKEN AKTIF'}" readonly>
                        <button id="copy-token-btn" class="bg-gray-200 text-gray-800 p-3 rounded-lg hover:bg-gray-300 transition duration-150">Salin</button>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-6">Token ini digunakan oleh Juri untuk membuka kunci penilaian yang sudah disimpan. Token harus diberikan secara manual kepada Juri.</p>
                    
                    <button id="generate-token-btn" class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-150">
                        Buat Token Baru (Edit)
                    </button>
                </div>
            `;
            
            document.getElementById('generate-token-btn').addEventListener('click', handleGenerateToken);
            document.getElementById('copy-token-btn').addEventListener('click', () => {
                const tokenInput = document.getElementById('current-token');
                tokenInput.select();
                // Fallback for copy command
                try {
                    document.execCommand('copy'); 
                    showMessage("Berhasil Disalin", "Token berhasil disalin ke clipboard.", 'success');
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    showMessage("Gagal Salin", "Gagal menyalin token. Silakan salin manual.", 'error');
                }
            });
        }

        function handleGenerateToken() {
            setLoading(true);
            const newToken = crypto.randomUUID().substring(0, 8).toUpperCase(); 

            try {
                const config = loadData(LS_KEYS.CONFIG);
                config.editToken = newToken;
                config.generatedBy = userName;
                config.timestamp = Date.now();
                saveData(LS_KEYS.CONFIG, config);
                
                showMessage("Token Dibuat", `Token baru '${newToken}' telah aktif. Berikan ini ke Juri yang membutuhkan.`, 'success');
            } catch (error) {
                console.error("Error generating token:", error);
                showMessage("Gagal", `Gagal membuat token: ${error.message}`, 'error');
            } finally {
                setLoading(false);
                refreshDataAndRender();
            }
        }
        
        // --- Kelola Kriteria (Unchanged) ---
        function renderCriteriaManagement() {
             const mainContent = document.getElementById('main-content');
             mainContent.innerHTML = `
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Kelola Kriteria Penilaian</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">Daftar Kriteria Aktif</h3>
                    <p class="text-sm text-gray-600 mb-4">Anda dapat mengubah nama kriteria atau nilai diskritnya di sini.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">No</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kriteria</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nilai (Cukup/Baik/BS)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${pbbCriteria.map((c, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">${c.category}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 w-1/3">${c.name}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 w-1/3">
                                            C: ${c.values.CUKUP.join('/')} | B: ${c.values.BAIK.join('/')} | BS: ${c.values.BAIK_SEKALI.join('/')}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="mt-4 text-sm text-red-500">Saat ini, perubahan nilai dan kriteria memerlukan pengubahan kode langsung untuk menghindari kompleksitas UI yang tinggi. Hubungi pengembang untuk perubahan yang mendalam.</p>
                </div>
            `;
        }

        // --- Rekap Nilai View (Unchanged logic for recap) ---

        function renderRecapDashboard() {
            const mainContent = document.getElementById('main-content');
            
            // Group scores by Team and calculate final total and average
            const teamRecap = participants.map(team => {
                const teamScores = scores.filter(s => s.teamId === team.id && s.isLocked);
                
                let judgeScores = {}; // Key: judgeId, Value: totalScore
                let criteriaScores = {}; // Key: criteriaId, Value: { judgeId: score, ... }
                
                // Initialize criteriaScores structure for all criteria
                pbbCriteria.forEach(criteria => {
                    criteriaScores[criteria.id] = {};
                });

                // Populate scores
                teamScores.forEach(score => {
                    judgeScores[score.judgeId] = score.totalScore;

                    // Kumpulkan skor kriteria dari setiap juri
                    Object.keys(score.scores).forEach(criteriaId => {
                        criteriaScores[criteriaId][score.judgeId] = score.scores[criteriaId].score;
                    });
                });

                const totalScoreSum = Object.values(judgeScores).reduce((sum, score) => sum + score, 0);
                const judgeCount = Object.keys(judgeScores).length;
                const averageScore = judgeCount > 0 ? (totalScoreSum / judgeCount).toFixed(2) : 0;
                
                return {
                    ...team,
                    judgeCount,
                    totalScoreSum,
                    averageScore,
                    judgeScores,
                    criteriaScores
                };
            });
            
            // Pilih tim yang sedang dilihat atau tim pertama
            let selectedTeam = teamRecap.find(p => p.id === currentTeamId);
             if (!selectedTeam && teamRecap.length > 0) {
                 selectedTeam = teamRecap[0];
             }
            if (selectedTeam) {
                currentTeamId = selectedTeam.id;
            } else {
                 currentTeamId = null;
            }

            const teamOptions = participants.map(p => 
                `<option value="${p.id}" ${p.id === currentTeamId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6 flex-wrap">
                    <h2 class="text-3xl font-semibold text-gray-800">Rekapitulasi Nilai</h2>
                    <select id="recap-team-select" class="p-2 border border-gray-300 rounded-lg shadow-sm font-medium w-40 mt-2 md:mt-0">
                        ${participants.length === 0 ? '<option value="">-- Tidak Ada Peserta --</option>' : teamOptions}
                    </select>
                </div>

                ${participants.length === 0 ? '<p class="text-center text-gray-500 p-10 bg-white rounded-xl shadow">Belum ada peserta untuk direkap.</p>' : ''}

                <div id="recap-area" class="${participants.length === 0 ? 'hidden' : ''}">
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Total Nilai Peserta: ${selectedTeam?.name || 'Pilih Peserta'}</h3>
                        <p class="text-4xl font-extrabold text-indigo-600 mb-4">${selectedTeam?.totalScoreSum || 0} <span class="text-gray-500 text-lg"> (Rata-rata: ${selectedTeam?.averageScore || 0})</span></p>
                        <p class="text-gray-600">Total Juri Menilai: ${selectedTeam?.judgeCount || 0}/${judges.length}</p>
                        
                        <button id="print-recap-btn" class="mt-4 bg-red-600 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-red-700 transition duration-150" ${!selectedTeam || selectedTeam.judgeCount === 0 ? 'disabled' : ''}>
                            Cetak Rekap PDF
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Tombol ini akan memunculkan menu cetak browser. Pilih "Simpan sebagai PDF" di tujuan cetak.</p>
                    </div>

                    <div id="pdf-recap-content" class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        ${selectedTeam ? renderDetailedRecapTable(selectedTeam) : '<p class="text-center text-gray-500 py-4">Pilih peserta untuk melihat detail nilai.</p>'}
                    </div>
                </div>
            `;
            
            if (participants.length > 0) {
                 document.getElementById('recap-team-select').addEventListener('change', (e) => {
                    currentTeamId = e.target.value;
                    refreshDataAndRender();
                });
            }
            
            if (selectedTeam && selectedTeam.judgeCount > 0) {
                document.getElementById('print-recap-btn').addEventListener('click', () => window.print());
            }
        }

        function renderDetailedRecapTable(teamData) {
            
            // Ambil semua Juri yang terdaftar
            const judgeHeaders = judges.map(j => ({ id: j.id, name: j.name }));
            
            const judgeHeaderHtml = judgeHeaders.map(j => 
                `<th class="text-xs font-semibold uppercase">${j.name}</th>`
            ).join('');

            let totalGrandTotalCriteriaScore = 0;

            const criteriaRowsHtml = pbbCriteria.map((criteria, index) => {
                let totalCriteriaScore = 0;
                
                const scoreCells = judgeHeaders.map(j => {
                    // Ambil nilai dari Juri tertentu. Default 0 jika Juri belum menilai.
                    const score = teamData.criteriaScores[criteria.id][j.id] || 0; 
                    totalCriteriaScore += score;
                    // Beri warna berbeda jika belum dinilai (skor 0)
                    const scoreColor = score > 0 ? 'text-gray-900 font-medium' : 'text-red-400 italic';
                    return `<td class="${scoreColor}">${score}</td>`;
                }).join('');

                totalGrandTotalCriteriaScore += totalCriteriaScore;

                return `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td>${index + 1}</td>
                        <td class="text-left">${criteria.name}</td>
                        ${scoreCells}
                        <td class="font-bold text-lg text-indigo-700">${totalCriteriaScore}</td>
                    </tr>
                `;
            }).join('');
            
            // Baris Total Nilai Per Juri
            const totalJudgeScoreCells = judgeHeaders.map(j => {
                const total = teamData.judgeScores[j.id] || 0;
                return `<td class="font-bold text-lg">${total}</td>`;
            }).join('');
            
            const totalJudgeCount = judgeHeaders.length;

            return `
                <div class="p-4">
                    <h3 class="text-xl font-bold text-center mb-6">REKAPITULASI NILAI PBB</h3>
                    <p class="text-md text-center font-bold mb-4">PESERTA: ${teamData.name}</p>

                    <div class="flex justify-around items-center mb-6">
                        <div class="text-center p-3 bg-indigo-50 rounded-lg shadow-inner">
                            <p class="text-xs text-gray-600">TOTAL NILAI AKHIR (${teamData.judgeCount}/${totalJudgeCount} JURI)</p>
                            <p class="header-total text-indigo-700">${teamData.totalScoreSum}</p>
                        </div>
                        <div class="text-center p-3 bg-indigo-50 rounded-lg shadow-inner">
                            <p class="text-xs text-gray-600">RATA-RATA NILAI</p>
                            <p class="header-total text-green-700">${teamData.averageScore}</p>
                        </div>
                    </div>

                    <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th rowspan="2" class="w-10 border-b-0">NO</th>
                                <th rowspan="2" class="text-left border-b-0">KRITERIA PENILAIAN</th>
                                <th colspan="${judgeHeaders.length}" class="border-b border-gray-300">NILAI PER JURI</th>
                                <th rowspan="2" class="bg-indigo-200 text-indigo-800 border-b-0">TOTAL NILAI KRITERIA</th>
                            </tr>
                            <tr>
                                ${judgeHeaderHtml}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${criteriaRowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="bg-indigo-200 font-bold text-indigo-800">
                                <td colspan="2" class="text-right">TOTAL NILAI JURI:</td>
                                ${totalJudgeScoreCells}
                                <td>${totalGrandTotalCriteriaScore}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <p class="text-xs text-gray-500 mt-6">Tabel ini menampilkan total akumulasi skor dari semua Juri yang telah memberikan nilai.</p>
                </div>
            `;
        }


        // ====================================================================
        // 5. AUTHENTICATION HANDLERS & UTILITIES
        // ====================================================================

        function handleLogin(event) {
            event.preventDefault();
            setLoading(true);
            
            const password = document.getElementById('password').value;

            let role = null;
            let displayName = null;

            if (password === ADMIN_PASSWORD) {
                role = 'admin';
                displayName = 'Administrator';
            } else if (password === SCORER_PASSWORD) {
                role = 'scorer';
                displayName = 'Juri Penilai'; // Akan diganti dengan nama Juri yang dipilih
            }

            if (role) {
                userRole = role;
                userName = displayName; // Set default display name

                localStorage.setItem(LS_KEYS.USER_ROLE, userRole);
                localStorage.setItem(LS_KEYS.USER_NAME, userName);
                
                showMessage("Login Berhasil", `Selamat datang, Anda login sebagai ${role.toUpperCase()}.`, 'success');
                
                // Jika login sebagai scorer, paksa memilih peran juri
                if (role === 'scorer') {
                    currentView = 'scorer_selection'; 
                } else {
                    currentView = 'admin';
                }

            } else {
                showMessage("Login Gagal", "Password salah atau tidak valid.", 'error');
            }
            refreshDataAndRender();
        }

        function handleLogout() {
            // Hapus semua data sesi (role, nama tampilan, id juri yang dipilih)
            localStorage.removeItem(LS_KEYS.USER_ROLE);
            localStorage.removeItem(LS_KEYS.USER_NAME);
            localStorage.removeItem(LS_KEYS.CURRENT_JUDGE_ID);
            sessionStorage.removeItem('current_edit_token');
            
            userRole = null;
            userName = null;
            currentJudgeId = null;
            currentView = 'login';
            
            refreshDataAndRender();
            showMessage("Logout", "Anda telah berhasil keluar dari sesi.", 'info');
        }

        function showMessage(title, message, type = 'info') {
            const modalContainer = document.getElementById('modal-container');
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'warning') bgColor = 'bg-yellow-600';

            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="p-2 rounded-full ${bgColor}">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${
                                type === 'success' ? 'M5 13l4 4L19 7' : 
                                type === 'error' ? 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' : 
                                'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                            }"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                    </div>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button id="close-modal-btn" class="w-full ${bgColor} text-white p-3 rounded-lg font-semibold hover:${bgColor.replace('-600', '-700')} transition duration-150">Tutup</button>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            
            document.getElementById('close-modal-btn').onclick = () => {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
            };
        }

        function showConfirmation(title, message) {
             return new Promise((resolve) => {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-btn" class="bg-gray-200 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Batal</button>
                            <button id="confirm-btn" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150">Ya, Lanjutkan</button>
                        </div>
                    </div>
                `;
                modalContainer.classList.remove('hidden');
                modalContainer.classList.add('flex');

                const closeModal = () => {
                    modalContainer.classList.add('hidden');
                    modalContainer.classList.remove('flex');
                };

                document.getElementById('cancel-btn').onclick = () => {
                    closeModal();
                    resolve(false);
                };
                document.getElementById('confirm-btn').onclick = () => {
                    closeModal();
                    resolve(true);
                };
            });
        }
        
        function showPrompt(title, message, defaultValue = '') {
            return new Promise((resolve) => {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <input type="text" id="prompt-input" value="${defaultValue}" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-btn" class="bg-gray-200 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Batal</button>
                            <button id="confirm-btn" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">OK</button>
                        </div>
                    </div>
                `;
                modalContainer.classList.remove('hidden');
                modalContainer.classList.add('flex');
                
                const inputEl = document.getElementById('prompt-input');
                inputEl.focus();

                const closeModal = () => {
                    modalContainer.classList.add('hidden');
                    modalContainer.classList.remove('flex');
                };

                document.getElementById('cancel-btn').onclick = () => {
                    closeModal();
                    resolve(null);
                };
                document.getElementById('confirm-btn').onclick = () => {
                    closeModal();
                    resolve(inputEl.value);
                };
                inputEl.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('confirm-btn').click();
                    }
                };
            });
        }

        
        // ====================================================================
        // 6. INITIAL STARTUP
        // ====================================================================

        window.onload = () => {
            // Inisialisasi awal hanya perlu memuat data dan merender
            refreshDataAndRender();
        };

    </script>
</body>
</html>