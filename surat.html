<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Bisnis - Profesional</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat html2pdf.js untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Menggunakan font Inter secara default */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        
        /* Style untuk area surat agar terlihat seperti kertas (Hanya untuk Pratinjau) */
        #letter-content {
            box-shadow: 0 0 40px -8px rgba(0, 0, 0, 0.2); /* Bayangan sangat elegan */
            background-color: white;
            padding: 3rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        /* Style umum untuk input form */
        .form-input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 1rem;
            background-color: #ffffff;
        }
        .form-input-field:focus {
            border-color: #10b981; /* Warna hijau mint/teal profesional */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            outline: none;
        }

        /* Style mewah untuk tombol */
        .btn-primary {
            background-image: linear-gradient(to right, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px -5px rgba(16, 185, 129, 0.5);
        }
        .btn-primary:hover {
            box-shadow: 0 8px 20px -7px rgba(16, 185, 129, 0.7);
            transform: translateY(-2px);
            background-image: linear-gradient(to right, #059669 0%, #10b981 100%);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Responsif untuk HP */
        @media (max-width: 640px) {
            #letter-content { padding: 1rem; }
            .text-xl { font-size: 1.15rem; }
            .text-lg { font-size: 1rem; }
            .form-input-field { padding: 0.5rem 0.75rem; }
            .hide-on-mobile { display: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- HEADER APLIKASI PROFESIONAL -->
    <header class="sticky top-0 z-20 bg-white border-b border-gray-200 shadow-md">
        <div class="container mx-auto max-w-6xl flex justify-between items-center py-4 px-4 sm:px-8">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-emerald-500 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <h1 class="text-xl font-bold text-gray-800">SuratPro - Generator Dokumen</h1>
            </div>
            <div id="auth-status" class="text-sm text-gray-600">
                <!-- Status User ID akan ditampilkan di sini -->
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-6xl p-4 sm:p-8">
        <div class="max-w-4xl mx-auto">
            
            <!-- Kontrol Tab -->
            <div class="flex justify-center border-b-2 border-gray-300 mb-8 mt-4 sticky top-[65px] bg-f0f4f8 z-10">
                <button id="tab-edit" onclick="showTab('edit')" class="tab-button px-6 py-3 text-sm font-medium transition-colors duration-200 focus:outline-none" aria-current="page">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Edit Data Surat
                </button>
                <button id="tab-preview" onclick="showTab('preview')" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Pratinjau & Unduh PDF
                </button>
            </div>

            <!-- Konten Aplikasi: Mode Edit (Form Input) -->
            <div id="content-edit" class="tab-content transition-opacity duration-300 bg-white p-6 sm:p-8 rounded-lg shadow-xl border border-gray-100">
                <div id="data-status" class="mb-4 text-center text-sm font-medium text-gray-500">
                    <span id="save-status">Status: Memuat data...</span>
                </div>

                <div class="space-y-8">
                    <!-- Bagian Kop Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-emerald-500 bg-gray-50 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-xl text-gray-800">1. Data Instansi</h3>
                        
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-kop-utama" class="block text-sm font-medium text-gray-700 mb-1">Kop Utama (Baris 1)</label>
                                <input type="text" id="input-kop-utama" data-field="kopUtama" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                            <div>
                                <label for="input-kop-sub2" class="block text-sm font-medium text-gray-700 mb-1">Nama Instansi</label>
                                <input type="text" id="input-kop-sub2" data-field="namaInstansi" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                        </div>
                        <div>
                            <label for="input-tanggal-surat" class="block text-sm font-medium text-gray-700 mb-1">Tempat, Tanggal Surat</label>
                            <input type="text" id="input-tanggal-surat" data-field="tanggalSurat" oninput="handleInputChange(this)" class="form-input-field">
                        </div>
                    </div>

                    <!-- Bagian Detail Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-amber-500 bg-white rounded-lg shadow">
                        <h3 class="font-semibold text-xl text-gray-800">2. Detail Surat</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-nomor" class="block text-sm font-medium text-gray-700 mb-1">Nomor</label>
                                <input type="text" id="input-nomor" data-field="nomor" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                            <div>
                                <label for="input-lampiran" class="block text-sm font-medium text-gray-700 mb-1">Lampiran</label>
                                <input type="text" id="input-lampiran" data-field="lampiran" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                        </div>
                        <div>
                            <label for="input-perihal" class="block text-sm font-medium text-gray-700 mb-1">Perihal</label>
                            <input type="text" id="input-perihal" data-field="perihal" oninput="handleInputChange(this)" class="form-input-field">
                        </div>
                         <div>
                            <label for="input-tujuan-nama" class="block text-sm font-medium text-gray-700 mb-1">Tujuan (Kepada Yth.)</label>
                            <input type="text" id="input-tujuan-nama" data-field="tujuanNama" oninput="handleInputChange(this)" class="form-input-field">
                        </div>
                    </div>

                    <!-- Bagian Isi Surat -->
                    <div class="space-y-4 p-4 border-l-4 border-emerald-500 bg-gray-50 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-xl text-gray-800">3. Isi & Rincian Kegiatan</h3>
                        <div>
                            <label for="input-isi-utama-1" class="block text-sm font-medium text-gray-700 mb-1">Paragraf Pembuka/Utama</label>
                            <textarea id="input-isi-utama-1" data-field="isiUtama" oninput="handleInputChange(this)" rows="4" class="form-input-field"></textarea>
                        </div>
                        <div>
                            <label for="input-detail-kegiatan" class="block text-sm font-medium text-gray-700 mb-1">Rincian Kegiatan (Gunakan baris baru untuk setiap detail)</label>
                            <textarea id="input-detail-kegiatan" data-field="detailKegiatan" oninput="handleInputChange(this)" rows="4" class="form-input-field"></textarea>
                        </div>
                        <div>
                            <label for="input-isi-penutup" class="block text-sm font-medium text-gray-700 mb-1">Paragraf Penutup</label>
                            <textarea id="input-isi-penutup" data-field="isiPenutup" oninput="handleInputChange(this)" rows="3" class="form-input-field"></textarea>
                        </div>
                    </div>

                     <!-- Bagian Tanda Tangan -->
                    <div class="space-y-4 p-4 border-l-4 border-amber-500 bg-white rounded-lg shadow">
                        <h3 class="font-semibold text-xl text-gray-800">4. Penandatangan</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="input-jabatan-kiri" class="block text-sm font-medium text-gray-700 mb-1">Jabatan Kiri</label>
                                <input type="text" id="input-jabatan-kiri" data-field="jabatanKiri" oninput="handleInputChange(this)" class="form-input-field">
                                <label for="input-nama-kiri" class="block text-sm font-medium text-gray-700 my-1">Nama Kiri</label>
                                <input type="text" id="input-nama-kiri" data-field="namaKiri" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                            <div>
                                <label for="input-jabatan-kanan" class="block text-sm font-medium text-gray-700 mb-1">Jabatan Kanan</label>
                                <input type="text" id="input-jabatan-kanan" data-field="jabatanKanan" oninput="handleInputChange(this)" class="form-input-field">
                                <label for="input-nama-kanan" class="block text-sm font-medium text-gray-700 my-1">Nama Kanan</label>
                                <input type="text" id="input-nama-kanan" data-field="namaKanan" oninput="handleInputChange(this)" class="form-input-field">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Akhir Konten Aplikasi: Mode Edit -->

            <!-- Konten Aplikasi: Pratinjau & Unduh PDF -->
            <div id="content-preview" class="tab-content hidden transition-opacity duration-300">

                 <!-- Kontrol Unduh PDF -->
                <div class="p-6 bg-white rounded-lg shadow-xl mb-8 border border-gray-100 flex flex-col sm:flex-row justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">Unduh Dokumen sebagai PDF</h2>
                    
                    <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                         <div class="w-full sm:w-auto">
                            <select id="paper-size-select" class="form-input-field p-2 text-sm">
                                <option value="a4">Ukuran Kertas: A4 (Standar)</option>
                                <option value="f4">Ukuran Kertas: F4 / Folio (Panjang)</option>
                            </select>
                        </div>
                        <button onclick="prepareAndDownloadPdf()" class="btn-primary text-white px-6 py-2.5 rounded-lg text-sm font-semibold w-full sm:w-auto shadow-lg hover:shadow-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            Unduh PDF Sekarang
                        </button>
                    </div>

                    <div id="loading-message" class="hidden absolute top-0 left-0 w-full h-full bg-white bg-opacity-90 flex items-center justify-center rounded-lg">
                        <svg class="animate-spin h-8 w-8 text-emerald-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-emerald-700 font-semibold">Memproses PDF...</span>
                    </div>
                </div>

                <!-- Area Pratinjau Surat -->
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 mt-10">Pratinjau Dokumen</h2>

                <div id="letter-content" class="min-h-[800px] rounded-lg overflow-hidden mx-auto">
                    
                    <!-- Kop Surat (Header) - Struktur yang rapi dan elegan -->
                    <div id="header-section" class="mb-8 pb-4 border-b-2 border-slate-400">
                        <div class="flex items-center justify-between">
                            <!-- Logo Kiri - (Silakan ubah SVG ini) -->
                            <div class="flex-shrink-0 mr-4">
                                <svg id="logo-placeholder" class="w-16 h-16 text-emerald-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>

                            <div class="flex-grow text-center">
                                <p class="text-2xl font-extrabold text-slate-800 leading-tight" id="preview-kop-utama"></p>
                                <p class="text-md text-gray-700 leading-tight" id="preview-kop-sub1">DINAS PENDIDIKAN DAN KEBUDAYAAN</p>
                                <p class="text-xl font-semibold text-emerald-600 leading-tight" id="preview-kop-sub2"></p>
                                <p class="text-xs text-gray-500 mt-1" id="preview-kop-alamat">Alamat: Kp. Pasir Galatik Desa Gumuruh Kec. Cileles-Lebak</p>
                            </div>

                             <!-- Logo Kanan - (Ganti URL placeholder dengan logo Anda) -->
                             <div class="flex-shrink-0 ml-4">
                                <img src="https://placehold.co/64x64/10b981/ffffff?text=LOGO" class="w-16 h-16 rounded-full" alt="Logo Sekolah" onerror="this.onerror=null;this.src='https://placehold.co/64x64/10b981/ffffff?text=LOGO'">
                            </div>
                        </div>
                    </div>

                    <!-- Tempat dan Tanggal -->
                    <p class="text-right text-sm text-gray-700 mb-8" id="preview-tanggal-surat"></p>

                    <!-- Informasi Surat -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 text-sm mb-8">
                        <div class="space-y-1">
                            <div class="flex">
                                <span class="w-24 font-medium text-gray-600">Nomor</span>
                                <span class="flex-grow font-semibold" id="preview-nomor"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 font-medium text-gray-600">Lampiran</span>
                                <span class="flex-grow" id="preview-lampiran"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 font-medium text-gray-600">Perihal</span>
                                <span class="flex-grow font-semibold text-emerald-600" id="preview-perihal"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Alamat Tujuan -->
                    <div class="mb-8 mt-10">
                        <p class="text-sm font-medium text-gray-700 mb-2">Kepada</p>
                        <p class="font-bold text-base text-gray-800" id="preview-tujuan-nama"></p>
                        <p class="text-sm text-gray-700">di Tempat</p>
                    </div>

                    <!-- Isi Surat -->
                    <div class="text-gray-700 space-y-4 text-base leading-relaxed">
                        <p>Dengan hormat,</p>
                        <p class="text-justify indent-8" id="preview-isi-utama-1"></p>

                        <!-- Detail Kegiatan (Diparsing dari textarea dengan baris baru) -->
                        <div class="ml-10 text-sm space-y-2 font-mono bg-gray-50 p-3 rounded-lg border" id="preview-detail-kegiatan">
                            <!-- Konten akan diisi oleh JS -->
                        </div>
                        
                        <p class="text-justify indent-8" id="preview-isi-penutup"></p>
                    </div>

                    <!-- Penutup dan Tanda Tangan -->
                    <div class="mt-16 flex justify-between text-sm">
                        <div class="w-1/2 pr-4 text-center">
                            <p class="font-medium mb-2">Hormat kami</p>
                            <p class="font-medium text-lg mb-16" id="preview-jabatan-kiri"></p>
                            
                            <p class="font-bold border-b border-gray-500 pb-0.5" id="preview-nama-kiri"></p>
                        </div>
                        <div class="w-1/2 pl-4 text-center">
                            <p class="font-medium mb-2 text-right invisible">.</p>
                            <p class="font-medium text-lg mb-16" id="preview-jabatan-kanan"></p>
                            
                            <p class="font-bold border-b border-gray-500 pb-0.5" id="preview-nama-kanan"></p>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Akhir Konten Aplikasi: Pratinjau & Unduh PDF -->

        </div>
    </main>

    <!-- Footer Simple -->
    <footer class="bg-gray-800 text-white mt-12 p-4 text-center">
        <div class="container mx-auto max-w-4xl text-sm opacity-80">
            <p>Sistem Pengarsipan Dokumen Profesional (Versi 1.0) | Disimpan di Cloud Firestore</p>
        </div>
    </footer>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- KONFIGURASI GLOBAL (DIPERLUKAN UNTUK CANVAS) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Your default config here if needed for local test */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- INISIALISASI FIREBASE ---
        let db;
        let auth;
        let userId = 'loading'; // Status awal
        let docRef;

        // Data default untuk surat
        const DEFAULT_DATA = {
            kopUtama: "PEMERINTAH KABUPATEN LEBAK",
            kopSub1: "DINAS PENDIDIKAN DAN KEBUDAYAAN",
            kopSub2: "SMP NEGERI 2 CILELES",
            kopAlamat: "Alamat: Kp. Pasir Galatik Desa Gumuruh Kec. Cileles-Lebak",
            tanggalSurat: "Cileles, 25 Nopember 2025",
            nomor: "421. /SMP/Filal/CLLS/XI/2025",
            lampiran: "-",
            perihal: "Pemberitahuan Kegiatan PERJUSAMI",
            tujuanNama: "Bapak Kepala SMP Negeri 2 Cileles",
            isiUtama: "Dalam rangka meningkatkan kedisiplinan, kemandirian, serta kemampuan kepramukaan peserta didik sebagai generasi muda yang berkarakter dan berjiwa Pancasila, kami bermaksud akan melaksanakan kegiatan Perkembangan Jumat Sabtu Minggu (Perjusami). Sehubungan dengan hal tersebut, bersama ini kami memberitahukan bahwa kegiatan akan dilaksanakan pada:",
            detailKegiatan: "Hari/Tanggal: Jumat s.d. minggu (7-9 Nopember 2025)\nPukul: 08.00 s.d Selesai\nTempat: Lapangan",
            isiPenutup: "Demikian pemberitahuan ini kami sampaikan. Besar harapan kami Bapak Kepala Sekolah memberikan izin pelaksanaan kegiatan tersebut. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.",
            jabatanKiri: "Ketua Pelaksana Kegiatan",
            namaKiri: "M. Nur Ikhwan, S. Pd.",
            jabatanKanan: "Sekretaris",
            namaKanan: "Danu Septiana, S. Pd.",
        };

        let letterData = { ...DEFAULT_DATA };
        let saveTimeout = null;

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `User ID: ${userId}`;
                        
                        // Path dokumen: /artifacts/{appId}/users/{userId}/surat_data/main_document
                        docRef = doc(db, 'artifacts', appId, 'users', userId, 'surat_data', 'main_document');
                        
                        // Mulai mendengarkan perubahan data
                        setupRealtimeListener();
                    } else {
                        userId = 'anonymous';
                        document.getElementById('auth-status').textContent = `User ID: ${userId}`;
                        console.error("Autentikasi gagal atau pengguna keluar.");
                    }
                });

            } catch (error) {
                console.error("Error saat inisialisasi Firebase:", error);
                document.getElementById('save-status').textContent = 'Error: Gagal terhubung ke database.';
            }
        }

        function setupRealtimeListener() {
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Data ditemukan, timpa data lokal
                    letterData = { ...DEFAULT_DATA, ...docSnap.data() };
                    document.getElementById('save-status').textContent = 'Status: Data dimuat dari cloud.';
                } else {
                    // Data belum ada, gunakan default dan simpan ke Firestore
                    document.getElementById('save-status').textContent = 'Status: Data baru, disimpan pertama kali.';
                    saveDataToFirestore(letterData);
                }
                // Sinkronkan data ke form dan pratinjau
                syncDataToForms();
            }, (error) => {
                console.error("Error listening to document:", error);
                document.getElementById('save-status').textContent = 'Error: Gagal mendengarkan perubahan data.';
            });
        }

        // Fungsi debounce untuk menyimpan ke Firestore
        function saveDataToFirestore(data) {
            if (!docRef) {
                console.error("Doc reference tidak siap.");
                return;
            }
            if (saveTimeout) clearTimeout(saveTimeout);
            
            document.getElementById('save-status').textContent = 'Status: Menyimpan...';

            saveTimeout = setTimeout(async () => {
                try {
                    await setDoc(docRef, data);
                    document.getElementById('save-status').textContent = 'Status: Tersimpan ke Cloud.';
                } catch (error) {
                    console.error("Error saving document:", error);
                    document.getElementById('save-status').textContent = 'Error: Gagal menyimpan data!';
                }
            }, 1000); // Tunggu 1 detik sebelum menyimpan
        }

        // --- HANDLERS DOM ---
        
        function handleInputChange(element) {
            const field = element.getAttribute('data-field');
            const value = element.value;
            
            if (field) {
                letterData[field] = value;
                saveDataToFirestore(letterData);
            }
        }
        window.handleInputChange = handleInputChange; // Ekspos ke global scope

        function syncDataToForms() {
            // Sinkronkan data dari state ke semua elemen form
            document.querySelectorAll('[data-field]').forEach(el => {
                const field = el.getAttribute('data-field');
                if (letterData[field] !== undefined) {
                    el.value = letterData[field];
                }
            });
            // Hapus status loading saat pertama kali data dimuat
            if (document.getElementById('save-status').textContent.includes('Memuat')) {
                document.getElementById('save-status').textContent = 'Status: Siap.';
            }
        }
        
        function synchronizePreview() {
            // Sinkronkan data dari state ke elemen pratinjau

            // Kop Surat
            document.getElementById('preview-kop-utama').textContent = letterData.kopUtama;
            document.getElementById('preview-kop-sub2').textContent = letterData.namaInstansi;
            document.getElementById('preview-tanggal-surat').textContent = letterData.tanggalSurat;
            
            // Detail Surat
            document.getElementById('preview-nomor').textContent = `: ${letterData.nomor}`;
            document.getElementById('preview-lampiran').textContent = `: ${letterData.lampiran}`;
            document.getElementById('preview-perihal').textContent = `: ${letterData.perihal}`;
            
            // Tujuan
            document.getElementById('preview-tujuan-nama').textContent = letterData.tujuanNama;

            // Isi Surat
            document.getElementById('preview-isi-utama-1').textContent = letterData.isiUtama;
            document.getElementById('preview-isi-penutup').textContent = letterData.isiPenutup;

            // Detail Kegiatan (memerlukan parsing baris baru)
            const detailKegiatanContainer = document.getElementById('preview-detail-kegiatan');
            const detailText = letterData.detailKegiatan;
            detailKegiatanContainer.innerHTML = ''; // Kosongkan
            
            detailText.split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parts.slice(1).join(':').trim(); // Menggabungkan kembali jika ada ':' di value
                    
                    const div = document.createElement('div');
                    div.className = 'flex';
                    div.innerHTML = `
                        <span class="w-32 font-medium">${key}</span>
                        <span class="flex-grow">: ${value}</span>
                    `;
                    detailKegiatanContainer.appendChild(div);
                }
            });
            
            // Tanda Tangan
            document.getElementById('preview-jabatan-kiri').textContent = letterData.jabatanKiri;
            document.getElementById('preview-nama-kiri').textContent = letterData.namaKiri;
            document.getElementById('preview-jabatan-kanan').textContent = letterData.jabatanKanan;
            document.getElementById('preview-nama-kanan').textContent = letterData.namaKanan;
        }

        // --- Fungsi Pengaturan Tampilan (Tabs) ---
        function showTab(tabName) {
            // Reset semua tampilan
            const contents = [contentEdit, contentPreview];
            contents.forEach(c => c.classList.add('hidden', 'opacity-0'));
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-emerald-500', 'text-emerald-600', 'font-semibold', 'border-b-2');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            // Tampilkan tab yang dipilih
            const selectedContent = document.getElementById(`content-${tabName}`);
            const selectedTab = document.getElementById(`tab-${tabName}`);

            if (selectedContent) {
                if (tabName === 'preview') {
                    // PENTING: Sinkronkan data sebelum menampilkan pratinjau
                    synchronizePreview();
                }
                
                selectedContent.classList.remove('hidden');
                setTimeout(() => selectedContent.classList.remove('opacity-0'), 10);
                selectedTab.classList.add('border-emerald-500', 'text-emerald-600', 'font-semibold', 'border-b-2');
                selectedTab.classList.remove('text-gray-500', 'hover:text-gray-700');
            }
        }
        window.showTab = showTab; // Ekspos ke global scope

        // --- Fungsi Unduh PDF ---
        function prepareAndDownloadPdf() {
            const paperSize = document.getElementById('paper-size-select').value;
            const content = document.getElementById('letter-content');
            const loadingMessage = document.getElementById('loading-message');

            // 1. Tampilkan indikator loading di atas kontrol download
            loadingMessage.classList.remove('hidden');
            
            // 2. Atur konfigurasi PDF
            let paperOptions;
            let filename;

            if (paperSize === 'a4') {
                // A4: 210 x 297 mm
                paperOptions = { width: 210, height: 297 };
                filename = 'Surat-A4-Profesional.pdf';
            } else if (paperSize === 'f4') {
                // F4/Folio: 215 x 330 mm 
                paperOptions = { width: 215, height: 330 }; 
                filename = 'Surat-F4-Profesional.pdf';
            } else {
                console.error("Ukuran kertas tidak valid.");
                loadingMessage.classList.add('hidden');
                return;
            }

            const opt = {
                margin: [15, 15, 15, 15], 
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false },
                jsPDF: { unit: 'mm', format: paperOptions, orientation: 'portrait' }
            };

            // 3. Proses konversi ke PDF
            setTimeout(() => {
                html2pdf().set(opt).from(content).save().then(() => {
                    // 4. Sembunyikan indikator loading
                    loadingMessage.classList.add('hidden');
                });
            }, 100);
        }
        window.prepareAndDownloadPdf = prepareAndDownloadPdf; // Ekspos ke global scope

        // --- START APLIKASI ---
        initFirebase();

    </script>

</body>
</html>